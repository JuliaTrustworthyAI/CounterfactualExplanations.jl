<!DOCTYPE html>
<html lang="en"><head><meta charset="UTF-8"/><meta name="viewport" content="width=device-width, initial-scale=1.0"/><title>Evaluating Explanations Â· CounterfactualExplanations.jl</title><script data-outdated-warner src="../../assets/warner.js"></script><link rel="canonical" href="https://juliatrustworthyai.github.io/CounterfactualExplanations.jl/tutorials/evaluation/"/><link href="https://cdnjs.cloudflare.com/ajax/libs/lato-font/3.0.0/css/lato-font.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/juliamono/0.045/juliamono.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/fontawesome.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/solid.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/brands.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/KaTeX/0.13.24/katex.min.css" rel="stylesheet" type="text/css"/><script>documenterBaseURL="../.."</script><script src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.6/require.min.js" data-main="../../assets/documenter.js"></script><script src="../../siteinfo.js"></script><script src="../../../versions.js"></script><link class="docs-theme-link" rel="stylesheet" type="text/css" href="../../assets/themes/documenter-dark.css" data-theme-name="documenter-dark" data-theme-primary-dark/><link class="docs-theme-link" rel="stylesheet" type="text/css" href="../../assets/themes/documenter-light.css" data-theme-name="documenter-light" data-theme-primary/><script src="../../assets/themeswap.js"></script></head><body><div id="documenter"><nav class="docs-sidebar"><a class="docs-logo" href="../../"><img src="../../assets/logo.svg" alt="CounterfactualExplanations.jl logo"/></a><div class="docs-package-name"><span class="docs-autofit"><a href="../../">CounterfactualExplanations.jl</a></span></div><form class="docs-search" action="../../search/"><input class="docs-search-query" id="documenter-search-query" name="q" type="text" placeholder="Search docs"/></form><ul class="docs-menu"><li><a class="tocitem" href="../../">ğŸ  Home</a></li><li><span class="tocitem">ğŸ«£ Tutorials</span><ul><li><a class="tocitem" href="../">Overview</a></li><li><a class="tocitem" href="../whistle_stop/">Whiste-Stop Tour</a></li><li><a class="tocitem" href="../data_preprocessing/">Handling Data</a></li><li><a class="tocitem" href="../data_catalogue/">Data Catalogue</a></li><li><a class="tocitem" href="../models/">Handling Models</a></li><li><a class="tocitem" href="../model_catalogue/">Model Catalogue</a></li><li><a class="tocitem" href="../generators/">Handing Generators</a></li><li class="is-active"><a class="tocitem" href>Evaluating Explanations</a><ul class="internal"><li><a class="tocitem" href="#Default-Measures"><span>Default Measures</span></a></li><li><a class="tocitem" href="#Custom-Measures"><span>Custom Measures</span></a></li><li><a class="tocitem" href="#Tidy-Output"><span>Tidy Output</span></a></li><li><a class="tocitem" href="#Multiple-Counterfactual-Explanations"><span>Multiple Counterfactual Explanations</span></a></li></ul></li><li><a class="tocitem" href="../benchmarking/">Benchmarking Explanations</a></li></ul></li><li><span class="tocitem">ğŸ¤“ Explanation</span><ul><li><a class="tocitem" href="../../explanation/">Overview</a></li><li><a class="tocitem" href="../../explanation/architecture/">Package Architecture</a></li><li><input class="collapse-toggle" id="menuitem-3-3" type="checkbox"/><label class="tocitem" for="menuitem-3-3"><span class="docs-label">Generators</span><i class="docs-chevron"></i></label><ul class="collapsed"><li><a class="tocitem" href="../../explanation/generators/overview/">Overview</a></li><li><a class="tocitem" href="../../explanation/generators/generic/">Generic</a></li><li><a class="tocitem" href="../../explanation/generators/gravitational/">Gravitational</a></li><li><a class="tocitem" href="../../explanation/generators/revise/">REVISE</a></li><li><a class="tocitem" href="../../explanation/generators/dice/">DiCE</a></li><li><a class="tocitem" href="../../explanation/generators/clap_roar/">ClaPROAR</a></li><li><a class="tocitem" href="../../explanation/generators/greedy/">Greedy</a></li></ul></li><li><input class="collapse-toggle" id="menuitem-3-4" type="checkbox"/><label class="tocitem" for="menuitem-3-4"><span class="docs-label">Optimisers</span><i class="docs-chevron"></i></label><ul class="collapsed"><li><a class="tocitem" href="../../explanation/optimisers/overview/">Overview</a></li><li><a class="tocitem" href="../../explanation/optimisers/jsma/">JSMA</a></li></ul></li><li><a class="tocitem" href="../../explanation/categorical/">Categorical Features</a></li></ul></li><li><span class="tocitem">ğŸ«¡ How-To ...</span><ul><li><a class="tocitem" href="../../how_to_guides/">Overview</a></li><li><a class="tocitem" href="../../how_to_guides/custom_generators/">... add custom generators</a></li><li><a class="tocitem" href="../../how_to_guides/custom_models/">... add custom models</a></li></ul></li><li><a class="tocitem" href="../../reference/">ğŸ§ Reference</a></li><li><a class="tocitem" href="../../contribute/">ğŸ›  Contribute</a></li><li><a class="tocitem" href="../../assets/resources/">ğŸ“š Additional Resources</a></li></ul><div class="docs-version-selector field has-addons"><div class="control"><span class="docs-label button is-static is-size-7">Version</span></div><div class="docs-selector control is-expanded"><div class="select is-fullwidth is-size-7"><select id="documenter-version-selector"></select></div></div></div></nav><div class="docs-main"><header class="docs-navbar"><nav class="breadcrumb"><ul class="is-hidden-mobile"><li><a class="is-disabled">ğŸ«£ Tutorials</a></li><li class="is-active"><a href>Evaluating Explanations</a></li></ul><ul class="is-hidden-tablet"><li class="is-active"><a href>Evaluating Explanations</a></li></ul></nav><div class="docs-right"><a class="docs-edit-link" href="https://github.com/juliatrustworthyai/CounterfactualExplanations.jl/blob/main/docs/src/tutorials/evaluation.md#" title="Edit on GitHub"><span class="docs-icon fab">ï‚›</span><span class="docs-label is-hidden-touch">Edit on GitHub</span></a><a class="docs-settings-button fas fa-cog" id="documenter-settings-button" href="#" title="Settings"></a><a class="docs-sidebar-button fa fa-bars is-hidden-desktop" id="documenter-sidebar-button" href="#"></a></div></header><article class="content" id="documenter-page"><h1 id="Performance-Evaluation"><a class="docs-heading-anchor" href="#Performance-Evaluation">Performance Evaluation</a><a id="Performance-Evaluation-1"></a><a class="docs-heading-anchor-permalink" href="#Performance-Evaluation" title="Permalink"></a></h1><p>Now that we know how to generate counterfactual explanations in Julia, you may have a few follow-up questions: How do I know if the counterfactual search has been successful? How good is my counterfactual explanation? What does â€˜goodâ€™ even mean in this context? In this tutorial, we will see how counterfactual explanations can be evaluated with respect to their performance.</p><h2 id="Default-Measures"><a class="docs-heading-anchor" href="#Default-Measures">Default Measures</a><a id="Default-Measures-1"></a><a class="docs-heading-anchor-permalink" href="#Default-Measures" title="Permalink"></a></h2><p>Numerous evaluation measures for counterfactual explanations have been proposed. In what follows, we will cover some of the most important measures.</p><h3 id="Single-Measure,-Single-Counterfactual"><a class="docs-heading-anchor" href="#Single-Measure,-Single-Counterfactual">Single Measure, Single Counterfactual</a><a id="Single-Measure,-Single-Counterfactual-1"></a><a class="docs-heading-anchor-permalink" href="#Single-Measure,-Single-Counterfactual" title="Permalink"></a></h3><p>One of the most important measures is <a href="../../reference/#CounterfactualExplanations.Evaluation.validity-Tuple{CounterfactualExplanation}"><code>validity</code></a>, which simply determines whether or not a counterfactual explanation <span>$x^{\prime}$</span> is valid in the sense that it yields the target prediction: <span>$M(x^{\prime})=t$</span>. We can evaluate the validity of a single counterfactual explanation <code>ce</code> using the <a href="../../reference/#CounterfactualExplanations.Evaluation.evaluate-Tuple{CounterfactualExplanation}"><code>Evaluation.evaluate</code></a> function as follows:</p><pre><code class="language-julia hljs">using CounterfactualExplanations.Evaluation: evaluate, validity
evaluate(ce; measure=validity)</code></pre><pre><code class="nohighlight hljs">1-element Vector{Vector{Float64}}:
 [1.0]</code></pre><p>For a single counterfactual explanation, this evaluation measure can only take two values: it is either equal to <code>1</code>, if the explanation is valid or <code>0</code> otherwise. Another important measure is <a href="../../reference/#CounterfactualExplanations.Objectives.distance"><code>distance</code></a>, which relates to the distance between the factual <span>$x$</span> and the counterfactual <span>$x^{\prime}$</span>. In the context of Algorithmic Recourse, higher distances are typically associated with higher costs to individuals seeking recourse.</p><pre><code class="language-julia hljs">using CounterfactualExplanations.Evaluation: distance
evaluate(ce; measure=distance)</code></pre><pre><code class="nohighlight hljs">1-element Vector{Vector{Float32}}:
 [0.77465737]</code></pre><p>By default, <code>distance</code> computes the L2 (Euclidean) distance.</p><h3 id="Multiple-Measures,-Single-Counterfactual"><a class="docs-heading-anchor" href="#Multiple-Measures,-Single-Counterfactual">Multiple Measures, Single Counterfactual</a><a id="Multiple-Measures,-Single-Counterfactual-1"></a><a class="docs-heading-anchor-permalink" href="#Multiple-Measures,-Single-Counterfactual" title="Permalink"></a></h3><p>You might be interested in computing not just the L2 distance, but various LP norms. This can be done by supplying a vector of functions to the <code>measure</code> key argument. For convenience, all default distance measures have already been collected in a vector:</p><pre><code class="language-julia hljs">using CounterfactualExplanations.Evaluation: distance_measures
distance_measures</code></pre><pre><code class="nohighlight hljs">4-element Vector{Function}:
 distance_l0 (generic function with 1 method)
 distance_l1 (generic function with 1 method)
 distance_l2 (generic function with 1 method)
 distance_linf (generic function with 1 method)</code></pre><p>We can use this vector of evaluation measures as follows:</p><pre><code class="language-julia hljs">evaluate(ce; measure=distance_measures)</code></pre><pre><code class="nohighlight hljs">4-element Vector{Vector{Float32}}:
 [2.0]
 [1.0941725]
 [0.77465737]
 [0.5743559]</code></pre><p>If no <code>measure</code> is specified, the <code>evaluate</code> method will return all default measures,</p><pre><code class="language-julia hljs">evaluate(ce)</code></pre><pre><code class="nohighlight hljs">3-element Vector{Vector}:
 [1.0]
 Float32[0.77465737]
 [0.0]</code></pre><p>which include:</p><pre><code class="language-julia hljs">CounterfactualExplanations.Evaluation.default_measures</code></pre><pre><code class="nohighlight hljs">3-element Vector{Function}:
 validity (generic function with 1 method)
 distance (generic function with 2 methods)
 redundancy (generic function with 1 method)</code></pre><h3 id="Multiple-Measures-and-Counterfactuals"><a class="docs-heading-anchor" href="#Multiple-Measures-and-Counterfactuals">Multiple Measures and Counterfactuals</a><a id="Multiple-Measures-and-Counterfactuals-1"></a><a class="docs-heading-anchor-permalink" href="#Multiple-Measures-and-Counterfactuals" title="Permalink"></a></h3><p>We can also evaluate multiple counterfactual explanations at once:</p><pre><code class="language-julia hljs">generator = DiCEGenerator()
ces = generate_counterfactual(x, target, counterfactual_data, M, generator; num_counterfactuals=5)
evaluate(ces)</code></pre><pre><code class="nohighlight hljs">3-element Vector{Vector}:
 [1.0]
 Float32[1.2271137]
 [0.0]</code></pre><p>By default, each evaluation measure is aggregated across all counterfactual explanations. To return individual measures for each counterfactual explanation you can specify <code>report_each=true</code></p><pre><code class="language-julia hljs">evaluate(ces; report_each=true)</code></pre><pre><code class="nohighlight hljs">3-element Vector{AbstractVector}:
 Bool[1, 1, 1, 1, 1]
 Float32[1.2219326, 1.2272075, 1.2317328, 1.2253546, 1.2293411]
 [0.0, 0.0, 0.0, 0.0, 0.0]</code></pre><h2 id="Custom-Measures"><a class="docs-heading-anchor" href="#Custom-Measures">Custom Measures</a><a id="Custom-Measures-1"></a><a class="docs-heading-anchor-permalink" href="#Custom-Measures" title="Permalink"></a></h2><p>A <code>measure</code> is just a method that takes a <code>CounterfactualExplanation</code> as its only positional argument. Defining custom measures is therefore straightforward. For example, we could define a measure to compute the inverse target probability as follows:</p><pre><code class="language-julia hljs">my_measure(ce::CounterfactualExplanation) = 1 .- CounterfactualExplanations.target_probs(ce)
evaluate(ce; measure=my_measure)</code></pre><pre><code class="nohighlight hljs">1-element Vector{Vector{Float32}}:
 [0.3637939]</code></pre><h2 id="Tidy-Output"><a class="docs-heading-anchor" href="#Tidy-Output">Tidy Output</a><a id="Tidy-Output-1"></a><a class="docs-heading-anchor-permalink" href="#Tidy-Output" title="Permalink"></a></h2><p>By default, <code>evaluate</code> returns vectors of evaluation measures. The optional key argument <code>output_format::Symbol</code> can be used to post-process the output in two ways: firstly, to return the output as a dictionary, specify <code>output_format=:Dict</code>:</p><pre><code class="language-julia hljs">evaluate(ces; output_format=:Dict, report_each=true)</code></pre><pre><code class="nohighlight hljs">Dict{Symbol, AbstractVector} with 3 entries:
  :validity   =&gt; Bool[1, 1, 1, 1, 1]
  :redundancy =&gt; [0.0, 0.0, 0.0, 0.0, 0.0]
  :distance   =&gt; Float32[1.22193, 1.22721, 1.23173, 1.22535, 1.22934]</code></pre><p>Secondly, to return the output as a data frame, specify <code>output_format=:DataFrame</code>.</p><pre><code class="language-julia hljs">evaluate(ces; output_format=:DataFrame, report_each=true)</code></pre><p>By default, data frames are pivoted to long format using individual counterfactuals as the <code>id</code> column. This behaviour can be suppressed by specifying <code>pivot_longer=false</code>.</p><h2 id="Multiple-Counterfactual-Explanations"><a class="docs-heading-anchor" href="#Multiple-Counterfactual-Explanations">Multiple Counterfactual Explanations</a><a id="Multiple-Counterfactual-Explanations-1"></a><a class="docs-heading-anchor-permalink" href="#Multiple-Counterfactual-Explanations" title="Permalink"></a></h2><p>It may be necessary to generate counterfactual explanations for multiple individuals.</p><p>Below, for example, we first select multiple samples (5) from the non-target class and then generate counterfactual explanations for all of them.</p><pre><code class="language-julia hljs"># Factual and target:
ids = rand(findall(predict_label(M, counterfactual_data) .== factual), n_individuals)
xs = select_factual(counterfactual_data, ids)
ces = generate_counterfactual(xs, target, counterfactual_data, M, generator; num_counterfactuals=5)
evaluation = evaluate(ces)</code></pre><pre><code class="nohighlight hljs">15Ã—4 DataFrame
 Row â”‚ sample  num_counterfactual  variable    value   
     â”‚ Int64   Int64               String      Float64 
â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
   1 â”‚      1                   1  distance    1.17712
   2 â”‚      1                   1  redundancy  0.0
   3 â”‚      1                   1  validity    1.0
   4 â”‚      2                   1  distance    1.13625
   5 â”‚      2                   1  redundancy  0.0
   6 â”‚      2                   1  validity    1.0
   7 â”‚      3                   1  distance    1.13287
   8 â”‚      3                   1  redundancy  0.0
   9 â”‚      3                   1  validity    1.0
  10 â”‚      4                   1  distance    1.09652
  11 â”‚      4                   1  redundancy  0.0
  12 â”‚      4                   1  validity    1.0
  13 â”‚      5                   1  distance    1.1731
  14 â”‚      5                   1  redundancy  0.0
  15 â”‚      5                   1  validity    1.0</code></pre><p>This leads us to our next topic: Performance Benchmarks.</p></article><nav class="docs-footer"><a class="docs-footer-prevpage" href="../generators/">Â« Handing Generators</a><a class="docs-footer-nextpage" href="../benchmarking/">Benchmarking Explanations Â»</a><div class="flexbox-break"></div><p class="footer-message">Powered by <a href="https://github.com/JuliaDocs/Documenter.jl">Documenter.jl</a> and the <a href="https://julialang.org/">Julia Programming Language</a>.</p></nav></div><div class="modal" id="documenter-settings"><div class="modal-background"></div><div class="modal-card"><header class="modal-card-head"><p class="modal-card-title">Settings</p><button class="delete"></button></header><section class="modal-card-body"><p><label class="label">Theme</label><div class="select"><select id="documenter-themepicker"><option value="documenter-light">documenter-light</option><option value="documenter-dark">documenter-dark</option></select></div></p><hr/><p>This document was generated with <a href="https://github.com/JuliaDocs/Documenter.jl">Documenter.jl</a> version 0.27.24 on <span class="colophon-date" title="Thursday 16 March 2023 14:52">Thursday 16 March 2023</span>. Using Julia version 1.8.5.</p></section><footer class="modal-card-foot"></footer></div></div></div></body></html>
