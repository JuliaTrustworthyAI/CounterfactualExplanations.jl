<!DOCTYPE html>
<html lang="en"><head><meta charset="UTF-8"/><meta name="viewport" content="width=device-width, initial-scale=1.0"/><title>Handling Generators Â· CounterfactualExplanations.jl</title><script data-outdated-warner src="../../assets/warner.js"></script><link rel="canonical" href="https://juliatrustworthyai.github.io/CounterfactualExplanations.jl/tutorials/generators/"/><link href="https://cdnjs.cloudflare.com/ajax/libs/lato-font/3.0.0/css/lato-font.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/juliamono/0.045/juliamono.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/fontawesome.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/solid.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/brands.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/KaTeX/0.13.24/katex.min.css" rel="stylesheet" type="text/css"/><script>documenterBaseURL="../.."</script><script src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.6/require.min.js" data-main="../../assets/documenter.js"></script><script src="../../siteinfo.js"></script><script src="../../../versions.js"></script><link class="docs-theme-link" rel="stylesheet" type="text/css" href="../../assets/themes/documenter-dark.css" data-theme-name="documenter-dark" data-theme-primary-dark/><link class="docs-theme-link" rel="stylesheet" type="text/css" href="../../assets/themes/documenter-light.css" data-theme-name="documenter-light" data-theme-primary/><script src="../../assets/themeswap.js"></script></head><body><div id="documenter"><nav class="docs-sidebar"><a class="docs-logo" href="../../"><img src="../../assets/logo.svg" alt="CounterfactualExplanations.jl logo"/></a><div class="docs-package-name"><span class="docs-autofit"><a href="../../">CounterfactualExplanations.jl</a></span></div><form class="docs-search" action="../../search/"><input class="docs-search-query" id="documenter-search-query" name="q" type="text" placeholder="Search docs"/></form><ul class="docs-menu"><li><a class="tocitem" href="../../">ğŸ  Home</a></li><li><span class="tocitem">ğŸ«£ Tutorials</span><ul><li><a class="tocitem" href="../">Overview</a></li><li><a class="tocitem" href="../simple_example/">Simple Example</a></li><li><a class="tocitem" href="../whistle_stop/">Whiste-Stop Tour</a></li><li><a class="tocitem" href="../data_preprocessing/">Handling Data</a></li><li><a class="tocitem" href="../data_catalogue/">Data Catalogue</a></li><li><a class="tocitem" href="../models/">Handling Models</a></li><li><a class="tocitem" href="../model_catalogue/">Model Catalogue</a></li><li class="is-active"><a class="tocitem" href>Handling Generators</a><ul class="internal"><li><a class="tocitem" href="#Composable-Generators"><span>Composable Generators</span></a></li><li><a class="tocitem" href="#Off-the-Shelf-Generators"><span>Off-the-Shelf Generators</span></a></li><li><a class="tocitem" href="#References"><span>References</span></a></li></ul></li><li><a class="tocitem" href="../evaluation/">Evaluating Explanations</a></li><li><a class="tocitem" href="../benchmarking/">Benchmarking Explanations</a></li></ul></li><li><span class="tocitem">ğŸ¤“ Explanation</span><ul><li><a class="tocitem" href="../../explanation/">Overview</a></li><li><a class="tocitem" href="../../explanation/architecture/">Package Architecture</a></li><li><input class="collapse-toggle" id="menuitem-3-3" type="checkbox"/><label class="tocitem" for="menuitem-3-3"><span class="docs-label">Generators</span><i class="docs-chevron"></i></label><ul class="collapsed"><li><a class="tocitem" href="../../explanation/generators/overview/">Overview</a></li><li><a class="tocitem" href="../../explanation/generators/generic/">Generic</a></li><li><a class="tocitem" href="../../explanation/generators/clap_roar/">ClaPROAR</a></li><li><a class="tocitem" href="../../explanation/generators/clue/">CLUE</a></li><li><a class="tocitem" href="../../explanation/generators/dice/">DiCE</a></li><li><a class="tocitem" href="../../explanation/generators/feature_tweak/">FeatureTweak</a></li><li><a class="tocitem" href="../../explanation/generators/gravitational/">Gravitational</a></li><li><a class="tocitem" href="../../explanation/generators/greedy/">Greedy</a></li><li><a class="tocitem" href="../../explanation/generators/growing_spheres/">GrowingSpheres</a></li><li><a class="tocitem" href="../../explanation/generators/probe/">PROBE</a></li><li><a class="tocitem" href="../../explanation/generators/revise/">REVISE</a></li></ul></li><li><input class="collapse-toggle" id="menuitem-3-4" type="checkbox"/><label class="tocitem" for="menuitem-3-4"><span class="docs-label">Optimisers</span><i class="docs-chevron"></i></label><ul class="collapsed"><li><a class="tocitem" href="../../explanation/optimisers/overview/">Overview</a></li><li><a class="tocitem" href="../../explanation/optimisers/jsma/">JSMA</a></li></ul></li><li><a class="tocitem" href="../../explanation/categorical/">Categorical Features</a></li></ul></li><li><span class="tocitem">ğŸ«¡ How-To ...</span><ul><li><a class="tocitem" href="../../how_to_guides/">Overview</a></li><li><a class="tocitem" href="../../how_to_guides/custom_generators/">... add custom generators</a></li><li><a class="tocitem" href="../../how_to_guides/custom_models/">... add custom models</a></li></ul></li><li><a class="tocitem" href="../../reference/">ğŸ§ Reference</a></li><li><a class="tocitem" href="../../contribute/">ğŸ›  Contribute</a></li><li><a class="tocitem" href="../../assets/resources/">ğŸ“š Additional Resources</a></li></ul><div class="docs-version-selector field has-addons"><div class="control"><span class="docs-label button is-static is-size-7">Version</span></div><div class="docs-selector control is-expanded"><div class="select is-fullwidth is-size-7"><select id="documenter-version-selector"></select></div></div></div></nav><div class="docs-main"><header class="docs-navbar"><nav class="breadcrumb"><ul class="is-hidden-mobile"><li><a class="is-disabled">ğŸ«£ Tutorials</a></li><li class="is-active"><a href>Handling Generators</a></li></ul><ul class="is-hidden-tablet"><li class="is-active"><a href>Handling Generators</a></li></ul></nav><div class="docs-right"><a class="docs-edit-link" href="https://github.com/juliatrustworthyai/CounterfactualExplanations.jl/blob/main/docs/src/tutorials/generators.md#" title="Edit on GitHub"><span class="docs-icon fab">ï‚›</span><span class="docs-label is-hidden-touch">Edit on GitHub</span></a><a class="docs-settings-button fas fa-cog" id="documenter-settings-button" href="#" title="Settings"></a><a class="docs-sidebar-button fa fa-bars is-hidden-desktop" id="documenter-sidebar-button" href="#"></a></div></header><article class="content" id="documenter-page"><h1 id="Handling-Generators"><a class="docs-heading-anchor" href="#Handling-Generators">Handling Generators</a><a id="Handling-Generators-1"></a><a class="docs-heading-anchor-permalink" href="#Handling-Generators" title="Permalink"></a></h1><p>Generating Counterfactual Explanations can be seen as a generative modelling task because it involves generating samples in the input space: <span>$x \sim \mathcal{X}$</span>. In this tutorial, we will introduce how Counterfactual <code>GradientBasedGenerator</code>s are used. They are discussed in more detail in the explanatory section of the documentation.</p><h2 id="Composable-Generators"><a class="docs-heading-anchor" href="#Composable-Generators">Composable Generators</a><a id="Composable-Generators-1"></a><a class="docs-heading-anchor-permalink" href="#Composable-Generators" title="Permalink"></a></h2><div class="admonition is-warning"><header class="admonition-header">Breaking Changes Expected</header><div class="admonition-body"><p>Work on this feature is still in its very early stages and breaking changes should be expected.</p></div></div><p>One of the key objectives for this package is <strong>Composability</strong>. It turns out that many of the various counterfactual generators that have been proposed in the literature, essentially do the same thing: they optimize an objective function. Formally we have,</p><p class="math-container">\[
\begin{aligned}
\mathbf{s}^\prime &amp;= \arg \min_{\mathbf{s}^\prime \in \mathcal{S}} \left\{  {\text{yloss}(M(f(\mathbf{s}^\prime)),y^*)}+ \lambda {\text{cost}(f(\mathbf{s}^\prime)) }  \right\} 
\end{aligned} 
 \qquad(1)\]</p><p>where <span>$\text{yloss}$</span> denotes the main loss function and <span>$\text{cost}$</span> is a penalty term (Altmeyer et al. 2023).</p><p>Without going into further detail here, the important thing to mention is that <a href="#eq-general">EquationÂ 1</a> very closely describes how counterfactual search is actually implemented in the package. In other words, all off-the-shelf generators currently implemented work with that same objective. They just vary in the way that penalties are defined, for example. This gives rise to an interesting idea:</p><blockquote><p>Why not compose generators that combine ideas from different off-the-shelf generators?</p></blockquote><p>The <a href="../../reference/#CounterfactualExplanations.Generators.GradientBasedGenerator"><code>GradientBasedGenerator</code></a> class provides a straightforward way to do this, without requiring users to build custom <code>GradientBasedGenerator</code>s from scratch. It can be instantiated as follows:</p><pre><code class="language-julia hljs">generator = GradientBasedGenerator()</code></pre><p>By default, this creates a <code>generator</code> that simply performs gradient descent without any penalties. To modify the behaviour of the <code>generator</code>, you can define the counterfactual search objective function using the <a href="../../reference/#CounterfactualExplanations.Generators.@objective-Tuple{Any, Any}"><code>@objective</code></a> macro:</p><pre><code class="language-julia hljs">@objective(generator, logitbinarycrossentropy + 0.1distance_l2 + 1.0ddp_diversity)</code></pre><p>Here we have essentially created a version of the <a href="../../reference/#CounterfactualExplanations.Generators.DiCEGenerator-Tuple{}"><code>DiCEGenerator</code></a>:</p><pre><code class="language-julia hljs">ce = generate_counterfactual(x, target, counterfactual_data, M, generator; num_counterfactuals=5)
plot(ce)</code></pre><p><img src="../generators_files/figure-commonmark/cell-5-output-1.svg" alt/></p><p>Multiple macros can be chained using <code>Chains.jl</code> making it easy to create entirely new flavours of counterfactual generators. The following generator, for example, combines ideas from DiCE (Mothilal, Sharma, and Tan 2020) and REVISE (Joshi et al. 2019):</p><pre><code class="language-julia hljs">@chain generator begin
    @objective logitcrossentropy + 1.0ddp_diversity     # DiCE (Mothilal et al. 2020)
    @with_optimiser Flux.Adam(0.1)                      
    @search_latent_space                                # REVISE (Joshi et al. 2019)
end</code></pre><p>Letâ€™s take this generator to our MNIST dataset and generate a counterfactual explanation for turning a 0 into a 8.</p><p><img src="../generators_files/figure-commonmark/cell-10-output-1.svg" alt/></p><h2 id="Off-the-Shelf-Generators"><a class="docs-heading-anchor" href="#Off-the-Shelf-Generators">Off-the-Shelf Generators</a><a id="Off-the-Shelf-Generators-1"></a><a class="docs-heading-anchor-permalink" href="#Off-the-Shelf-Generators" title="Permalink"></a></h2><p>Off-the-shelf generators are just default recipes for counterfactual generators. Currently, the following off-the-shelf counterfactual generators are implemented in the package:</p><pre><code class="language-julia hljs">generator_catalogue</code></pre><pre><code class="nohighlight hljs">Dict{Symbol, Any} with 11 entries:
  :gravitational   =&gt; GravitationalGenerator
  :growing_spheres =&gt; GrowingSpheresGenerator
  :revise          =&gt; REVISEGenerator
  :clue            =&gt; CLUEGenerator
  :probe           =&gt; ProbeGenerator
  :dice            =&gt; DiCEGenerator
  :feature_tweak   =&gt; FeatureTweakGenerator
  :claproar        =&gt; ClaPROARGenerator
  :wachter         =&gt; WachterGenerator
  :generic         =&gt; GenericGenerator
  :greedy          =&gt; GreedyGenerator</code></pre><p>To specify the type of generator you want to use, you can simply instantiate it:</p><pre><code class="language-julia hljs"># Search:
generator = GenericGenerator()
ce = generate_counterfactual(x, target, counterfactual_data, M, generator)
plot(ce)</code></pre><p><img src="../generators_files/figure-commonmark/cell-13-output-1.svg" alt/></p><p>We generally make an effort to follow the literature as closely as possible when implementing off-the-shelf generators.</p><h2 id="References"><a class="docs-heading-anchor" href="#References">References</a><a id="References-1"></a><a class="docs-heading-anchor-permalink" href="#References" title="Permalink"></a></h2><p>Altmeyer, Patrick, Giovan Angela, Aleksander Buszydlik, Karol Dobiczek, Arie van Deursen, and Cynthia Liem. 2023. â€œEndogenous Macrodynamics in Algorithmic Recourse.â€ In <em>First IEEE Conference on Secure and Trustworthy Machine Learning</em>.</p><p>Joshi, Shalmali, Oluwasanmi Koyejo, Warut Vijitbenjaronk, Been Kim, and Joydeep Ghosh. 2019. â€œTowards Realistic Individual Recourse and Actionable Explanations in Black-Box Decision Making Systems.â€ <a href="https://arxiv.org/abs/1907.09615">https://arxiv.org/abs/1907.09615</a>.</p><p>Mothilal, Ramaravind K, Amit Sharma, and Chenhao Tan. 2020. â€œExplaining Machine Learning Classifiers Through Diverse Counterfactual Explanations.â€ In <em>Proceedings of the 2020 Conference on Fairness, Accountability, and Transparency</em>, 607â€“17.</p></article><nav class="docs-footer"><a class="docs-footer-prevpage" href="../model_catalogue/">Â« Model Catalogue</a><a class="docs-footer-nextpage" href="../evaluation/">Evaluating Explanations Â»</a><div class="flexbox-break"></div><p class="footer-message">Powered by <a href="https://github.com/JuliaDocs/Documenter.jl">Documenter.jl</a> and the <a href="https://julialang.org/">Julia Programming Language</a>.</p></nav></div><div class="modal" id="documenter-settings"><div class="modal-background"></div><div class="modal-card"><header class="modal-card-head"><p class="modal-card-title">Settings</p><button class="delete"></button></header><section class="modal-card-body"><p><label class="label">Theme</label><div class="select"><select id="documenter-themepicker"><option value="documenter-light">documenter-light</option><option value="documenter-dark">documenter-dark</option></select></div></p><hr/><p>This document was generated with <a href="https://github.com/JuliaDocs/Documenter.jl">Documenter.jl</a> version 0.27.25 on <span class="colophon-date" title="Thursday 17 August 2023 08:04">Thursday 17 August 2023</span>. Using Julia version 1.9.2.</p></section><footer class="modal-card-foot"></footer></div></div></div></body></html>
