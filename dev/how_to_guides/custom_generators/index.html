<!DOCTYPE html>
<html lang="en"><head><meta charset="UTF-8"/><meta name="viewport" content="width=device-width, initial-scale=1.0"/><title>... add custom generators Â· CounterfactualExplanations.jl</title><meta name="title" content="... add custom generators Â· CounterfactualExplanations.jl"/><meta property="og:title" content="... add custom generators Â· CounterfactualExplanations.jl"/><meta property="twitter:title" content="... add custom generators Â· CounterfactualExplanations.jl"/><meta name="description" content="Documentation for CounterfactualExplanations.jl."/><meta property="og:description" content="Documentation for CounterfactualExplanations.jl."/><meta property="twitter:description" content="Documentation for CounterfactualExplanations.jl."/><meta property="og:url" content="https://juliatrustworthyai.github.io/CounterfactualExplanations.jl/stable/how_to_guides/custom_generators/"/><meta property="twitter:url" content="https://juliatrustworthyai.github.io/CounterfactualExplanations.jl/stable/how_to_guides/custom_generators/"/><link rel="canonical" href="https://juliatrustworthyai.github.io/CounterfactualExplanations.jl/stable/how_to_guides/custom_generators/"/><script data-outdated-warner src="../../assets/warner.js"></script><link href="https://cdnjs.cloudflare.com/ajax/libs/lato-font/3.0.0/css/lato-font.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/juliamono/0.050/juliamono.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/fontawesome.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/solid.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/brands.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/KaTeX/0.16.8/katex.min.css" rel="stylesheet" type="text/css"/><script>documenterBaseURL="../.."</script><script src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.6/require.min.js" data-main="../../assets/documenter.js"></script><script src="../../search_index.js"></script><script src="../../siteinfo.js"></script><script src="../../../versions.js"></script><link class="docs-theme-link" rel="stylesheet" type="text/css" href="../../assets/themes/catppuccin-mocha.css" data-theme-name="catppuccin-mocha"/><link class="docs-theme-link" rel="stylesheet" type="text/css" href="../../assets/themes/catppuccin-macchiato.css" data-theme-name="catppuccin-macchiato"/><link class="docs-theme-link" rel="stylesheet" type="text/css" href="../../assets/themes/catppuccin-frappe.css" data-theme-name="catppuccin-frappe"/><link class="docs-theme-link" rel="stylesheet" type="text/css" href="../../assets/themes/catppuccin-latte.css" data-theme-name="catppuccin-latte"/><link class="docs-theme-link" rel="stylesheet" type="text/css" href="../../assets/themes/documenter-dark.css" data-theme-name="documenter-dark" data-theme-primary-dark/><link class="docs-theme-link" rel="stylesheet" type="text/css" href="../../assets/themes/documenter-light.css" data-theme-name="documenter-light" data-theme-primary/><script src="../../assets/themeswap.js"></script></head><body><div id="documenter"><nav class="docs-sidebar"><a class="docs-logo" href="../../"><img src="../../assets/logo.svg" alt="CounterfactualExplanations.jl logo"/></a><div class="docs-package-name"><span class="docs-autofit"><a href="../../">CounterfactualExplanations.jl</a></span></div><button class="docs-search-query input is-rounded is-small is-clickable my-2 mx-auto py-1 px-2" id="documenter-search-query">Search docs (Ctrl + /)</button><ul class="docs-menu"><li><a class="tocitem" href="../../">ğŸ  Home</a></li><li><span class="tocitem">ğŸ«£ Tutorials</span><ul><li><a class="tocitem" href="../../tutorials/">Overview</a></li><li><a class="tocitem" href="../../tutorials/simple_example/">Simple Example</a></li><li><a class="tocitem" href="../../tutorials/whistle_stop/">Whiste-Stop Tour</a></li><li><a class="tocitem" href="../../tutorials/data_preprocessing/">Handling Data</a></li><li><a class="tocitem" href="../../tutorials/data_catalogue/">Data Catalogue</a></li><li><a class="tocitem" href="../../tutorials/models/">Handling Models</a></li><li><a class="tocitem" href="../../tutorials/model_catalogue/">Model Catalogue</a></li><li><a class="tocitem" href="../../tutorials/generators/">Handling Generators</a></li><li><a class="tocitem" href="../../tutorials/evaluation/">Evaluating Explanations</a></li><li><a class="tocitem" href="../../tutorials/benchmarking/">Benchmarking Explanations</a></li><li><a class="tocitem" href="../../tutorials/parallelization/">Parallelization</a></li><li><a class="tocitem" href="../../tutorials/convergence/">Convergence</a></li></ul></li><li><span class="tocitem">ğŸ¤“ Explanation</span><ul><li><a class="tocitem" href="../../explanation/">Overview</a></li><li><a class="tocitem" href="../../explanation/architecture/">Package Architecture</a></li><li><input class="collapse-toggle" id="menuitem-3-3" type="checkbox"/><label class="tocitem" for="menuitem-3-3"><span class="docs-label">Generators</span><i class="docs-chevron"></i></label><ul class="collapsed"><li><a class="tocitem" href="../../explanation/generators/overview/">Overview</a></li><li><a class="tocitem" href="../../explanation/generators/generic/">Generic</a></li><li><a class="tocitem" href="../../explanation/generators/clap_roar/">ClaPROAR</a></li><li><a class="tocitem" href="../../explanation/generators/clue/">CLUE</a></li><li><a class="tocitem" href="../../explanation/generators/dice/">DiCE</a></li><li><a class="tocitem" href="../../explanation/generators/feature_tweak/">FeatureTweak</a></li><li><a class="tocitem" href="../../explanation/generators/gravitational/">Gravitational</a></li><li><a class="tocitem" href="../../explanation/generators/greedy/">Greedy</a></li><li><a class="tocitem" href="../../explanation/generators/growing_spheres/">GrowingSpheres</a></li><li><a class="tocitem" href="../../explanation/generators/probe/">PROBE</a></li><li><a class="tocitem" href="../../explanation/generators/revise/">REVISE</a></li></ul></li><li><input class="collapse-toggle" id="menuitem-3-4" type="checkbox"/><label class="tocitem" for="menuitem-3-4"><span class="docs-label">Evaluation</span><i class="docs-chevron"></i></label><ul class="collapsed"><li><a class="tocitem" href="../../explanation/evaluation/overview/">Overview</a></li><li><a class="tocitem" href="../../explanation/evaluation/faithfulness/">Plausibility and Faithfulness</a></li></ul></li><li><input class="collapse-toggle" id="menuitem-3-5" type="checkbox"/><label class="tocitem" for="menuitem-3-5"><span class="docs-label">Optimisers</span><i class="docs-chevron"></i></label><ul class="collapsed"><li><a class="tocitem" href="../../explanation/optimisers/overview/">Overview</a></li><li><a class="tocitem" href="../../explanation/optimisers/jsma/">JSMA</a></li></ul></li><li><a class="tocitem" href="../../explanation/categorical/">Categorical Features</a></li></ul></li><li><span class="tocitem">ğŸ«¡ How-To ...</span><ul><li><a class="tocitem" href="../">Overview</a></li><li class="is-active"><a class="tocitem" href>... add custom generators</a><ul class="internal"><li><a class="tocitem" href="#Generic-generator-with-dropout"><span>Generic generator with dropout</span></a></li></ul></li><li><a class="tocitem" href="../custom_models/">... add custom models</a></li></ul></li><li><span class="tocitem">â›“ï¸ Extensions</span><ul><li><a class="tocitem" href="../../extensions/">Overview</a></li><li><a class="tocitem" href="../../extensions/neurotree/">NeuroTrees</a></li><li><a class="tocitem" href="../../extensions/laplace_redux/">LaplaceRedux</a></li></ul></li><li><a class="tocitem" href="../../reference/">ğŸ§ Reference</a></li><li><a class="tocitem" href="../../contribute/">ğŸ›  Contribute</a></li><li><a class="tocitem" href="../../assets/resources/">ğŸ“š Additional Resources</a></li><li><a class="tocitem" href="../../release-notes/">Release Notes</a></li></ul><div class="docs-version-selector field has-addons"><div class="control"><span class="docs-label button is-static is-size-7">Version</span></div><div class="docs-selector control is-expanded"><div class="select is-fullwidth is-size-7"><select id="documenter-version-selector"></select></div></div></div></nav><div class="docs-main"><header class="docs-navbar"><a class="docs-sidebar-button docs-navbar-link fa-solid fa-bars is-hidden-desktop" id="documenter-sidebar-button" href="#"></a><nav class="breadcrumb"><ul class="is-hidden-mobile"><li><a class="is-disabled">ğŸ«¡ How-To ...</a></li><li class="is-active"><a href>... add custom generators</a></li></ul><ul class="is-hidden-tablet"><li class="is-active"><a href>... add custom generators</a></li></ul></nav><div class="docs-right"><a class="docs-navbar-link" href="https://github.com/juliatrustworthyai/CounterfactualExplanations.jl" title="View the repository on GitHub"><span class="docs-icon fa-brands">ï‚›</span><span class="docs-label is-hidden-touch">GitHub</span></a><a class="docs-navbar-link" href="https://github.com/juliatrustworthyai/CounterfactualExplanations.jl/blob/main/docs/src/how_to_guides/custom_generators.md" title="Edit source on GitHub"><span class="docs-icon fa-solid">ï„</span></a><a class="docs-settings-button docs-navbar-link fa-solid fa-gear" id="documenter-settings-button" href="#" title="Settings"></a><a class="docs-article-toggle-button fa-solid fa-chevron-up" id="documenter-article-toggle-button" href="javascript:;" title="Collapse all docstrings"></a></div></header><article class="content" id="documenter-page"><h1 id="How-to-add-Custom-Generators"><a class="docs-heading-anchor" href="#How-to-add-Custom-Generators">How to add Custom Generators</a><a id="How-to-add-Custom-Generators-1"></a><a class="docs-heading-anchor-permalink" href="#How-to-add-Custom-Generators" title="Permalink"></a></h1><p>As we will see in this short tutorial, building custom counterfactual generators is straightforward. We hope that this will facilitate contributions through the community.</p><h2 id="Generic-generator-with-dropout"><a class="docs-heading-anchor" href="#Generic-generator-with-dropout">Generic generator with dropout</a><a id="Generic-generator-with-dropout-1"></a><a class="docs-heading-anchor-permalink" href="#Generic-generator-with-dropout" title="Permalink"></a></h2><p>To illustrate how custom generators can be implemented we will consider a simple example of a generator that extends the functionality of our <code>GenericGenerator</code>. We have noted elsewhere that the effectiveness of counterfactual explanations depends to some degree on the quality of the fitted model. Another, perhaps trivial, thing to note is that counterfactual explanations are not unique: there are potentially many valid counterfactual paths. One interesting (or silly) idea following these two observations might be to introduce some form of regularization in the counterfactual search. For example, we could use dropout to randomly switch features on and off in each iteration. Without dwelling further on the usefulness of this idea, let us see how it can be implemented.</p><p>The first code chunk below implements two important steps: 1) create an abstract subtype of the <code>AbstractGradientBasedGenerator</code> and 2) create a constructor similar to the <code>GenericConstructor</code>, but with one additional field for the probability of dropout.</p><pre><code class="language-julia hljs"># Abstract suptype:
abstract type AbstractDropoutGenerator &lt;: AbstractGradientBasedGenerator end

# Constructor:
struct DropoutGenerator &lt;: AbstractDropoutGenerator
    loss::Function # loss function
    penalty::Function
    Î»::AbstractFloat # strength of penalty
    latent_space::Bool
    opt::Any # optimizer
    generative_model_params::NamedTuple
    p_dropout::AbstractFloat # dropout rate
end

# Instantiate:
generator = DropoutGenerator(
    Flux.logitbinarycrossentropy,
    CounterfactualExplanations.Objectives.distance_l1,
    0.1,
    false,
    Flux.Optimise.Descent(0.1),
    (;),
    0.5,
)</code></pre><p>Next, we define how feature perturbations are generated for our dropout generator: in particular, we extend the relevant function through a method that implemented the dropout logic.</p><pre><code class="language-julia hljs">using CounterfactualExplanations.Generators
using StatsBase
function Generators.generate_perturbations(
    generator::AbstractDropoutGenerator, 
    ce::CounterfactualExplanation
)
    sâ€² = deepcopy(ce.sâ€²)
    new_sâ€² = Generators.propose_state(generator, ce)
    Î”sâ€² = new_sâ€² - sâ€² # gradient step

    # Dropout:
    set_to_zero = sample(
        1:length(Î”sâ€²),
        Int(round(generator.p_dropout*length(Î”sâ€²))),
        replace=false
    )
    Î”sâ€²[set_to_zero] .= 0
    return Î”sâ€²
end</code></pre><p>Finally, we proceed to generate counterfactuals in the same way we always do:</p><pre><code class="language-julia hljs"># Data and Classifier:
M = fit_model(counterfactual_data, :DeepEnsemble)

# Factual and Target:
yhat = predict_label(M, counterfactual_data)
target = 2    # target label
candidates = findall(vec(yhat) .!= target)
chosen = rand(candidates)
x = select_factual(counterfactual_data, chosen)

# Counterfactual search:
ce = generate_counterfactual(
    x, target, counterfactual_data, M, generator;
    num_counterfactuals=5)

plot(ce)</code></pre><p><img src="../custom_generators_files/figure-commonmark/cell-5-output-1.svg" alt/></p></article><nav class="docs-footer"><a class="docs-footer-prevpage" href="../">Â« Overview</a><a class="docs-footer-nextpage" href="../custom_models/">... add custom models Â»</a><div class="flexbox-break"></div><p class="footer-message">Powered by <a href="https://github.com/JuliaDocs/Documenter.jl">Documenter.jl</a> and the <a href="https://julialang.org/">Julia Programming Language</a>.</p></nav></div><div class="modal" id="documenter-settings"><div class="modal-background"></div><div class="modal-card"><header class="modal-card-head"><p class="modal-card-title">Settings</p><button class="delete"></button></header><section class="modal-card-body"><p><label class="label">Theme</label><div class="select"><select id="documenter-themepicker"><option value="auto">Automatic (OS)</option><option value="documenter-light">documenter-light</option><option value="documenter-dark">documenter-dark</option><option value="catppuccin-latte">catppuccin-latte</option><option value="catppuccin-frappe">catppuccin-frappe</option><option value="catppuccin-macchiato">catppuccin-macchiato</option><option value="catppuccin-mocha">catppuccin-mocha</option></select></div></p><hr/><p>This document was generated with <a href="https://github.com/JuliaDocs/Documenter.jl">Documenter.jl</a> version 1.7.0 on <span class="colophon-date" title="Tuesday 10 September 2024 12:38">Tuesday 10 September 2024</span>. Using Julia version 1.10.5.</p></section><footer class="modal-card-foot"></footer></div></div></div></body></html>
