<!DOCTYPE html>
<html lang="en"><head><meta charset="UTF-8"/><meta name="viewport" content="width=device-width, initial-scale=1.0"/><title>... add custom models ¬∑ CounterfactualExplanations.jl</title><meta name="title" content="... add custom models ¬∑ CounterfactualExplanations.jl"/><meta property="og:title" content="... add custom models ¬∑ CounterfactualExplanations.jl"/><meta property="twitter:title" content="... add custom models ¬∑ CounterfactualExplanations.jl"/><meta name="description" content="Documentation for CounterfactualExplanations.jl."/><meta property="og:description" content="Documentation for CounterfactualExplanations.jl."/><meta property="twitter:description" content="Documentation for CounterfactualExplanations.jl."/><meta property="og:url" content="https://juliatrustworthyai.github.io/CounterfactualExplanations.jl/how_to_guides/custom_models/"/><meta property="twitter:url" content="https://juliatrustworthyai.github.io/CounterfactualExplanations.jl/how_to_guides/custom_models/"/><link rel="canonical" href="https://juliatrustworthyai.github.io/CounterfactualExplanations.jl/how_to_guides/custom_models/"/><script data-outdated-warner src="../../assets/warner.js"></script><link href="https://cdnjs.cloudflare.com/ajax/libs/lato-font/3.0.0/css/lato-font.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/juliamono/0.050/juliamono.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/fontawesome.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/solid.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/brands.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/KaTeX/0.16.8/katex.min.css" rel="stylesheet" type="text/css"/><script>documenterBaseURL="../.."</script><script src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.6/require.min.js" data-main="../../assets/documenter.js"></script><script src="../../search_index.js"></script><script src="../../siteinfo.js"></script><script src="../../../versions.js"></script><link class="docs-theme-link" rel="stylesheet" type="text/css" href="../../assets/themes/documenter-dark.css" data-theme-name="documenter-dark" data-theme-primary-dark/><link class="docs-theme-link" rel="stylesheet" type="text/css" href="../../assets/themes/documenter-light.css" data-theme-name="documenter-light" data-theme-primary/><script src="../../assets/themeswap.js"></script></head><body><div id="documenter"><nav class="docs-sidebar"><a class="docs-logo" href="../../"><img src="../../assets/logo.svg" alt="CounterfactualExplanations.jl logo"/></a><div class="docs-package-name"><span class="docs-autofit"><a href="../../">CounterfactualExplanations.jl</a></span></div><button class="docs-search-query input is-rounded is-small is-clickable my-2 mx-auto py-1 px-2" id="documenter-search-query">Search docs (Ctrl + /)</button><ul class="docs-menu"><li><a class="tocitem" href="../../">üè† Home</a></li><li><span class="tocitem">ü´£ Tutorials</span><ul><li><a class="tocitem" href="../../tutorials/">Overview</a></li><li><a class="tocitem" href="../../tutorials/simple_example/">Simple Example</a></li><li><a class="tocitem" href="../../tutorials/whistle_stop/">Whiste-Stop Tour</a></li><li><a class="tocitem" href="../../tutorials/data_preprocessing/">Handling Data</a></li><li><a class="tocitem" href="../../tutorials/data_catalogue/">Data Catalogue</a></li><li><a class="tocitem" href="../../tutorials/models/">Handling Models</a></li><li><a class="tocitem" href="../../tutorials/model_catalogue/">Model Catalogue</a></li><li><a class="tocitem" href="../../tutorials/generators/">Handling Generators</a></li><li><a class="tocitem" href="../../tutorials/evaluation/">Evaluating Explanations</a></li><li><a class="tocitem" href="../../tutorials/benchmarking/">Benchmarking Explanations</a></li><li><a class="tocitem" href="../../tutorials/parallelization/">Parallelization</a></li></ul></li><li><span class="tocitem">ü§ì Explanation</span><ul><li><a class="tocitem" href="../../explanation/">Overview</a></li><li><a class="tocitem" href="../../explanation/architecture/">Package Architecture</a></li><li><input class="collapse-toggle" id="menuitem-3-3" type="checkbox"/><label class="tocitem" for="menuitem-3-3"><span class="docs-label">Generators</span><i class="docs-chevron"></i></label><ul class="collapsed"><li><a class="tocitem" href="../../explanation/generators/overview/">Overview</a></li><li><a class="tocitem" href="../../explanation/generators/generic/">Generic</a></li><li><a class="tocitem" href="../../explanation/generators/clap_roar/">ClaPROAR</a></li><li><a class="tocitem" href="../../explanation/generators/clue/">CLUE</a></li><li><a class="tocitem" href="../../explanation/generators/dice/">DiCE</a></li><li><a class="tocitem" href="../../explanation/generators/feature_tweak/">FeatureTweak</a></li><li><a class="tocitem" href="../../explanation/generators/gravitational/">Gravitational</a></li><li><a class="tocitem" href="../../explanation/generators/greedy/">Greedy</a></li><li><a class="tocitem" href="../../explanation/generators/growing_spheres/">GrowingSpheres</a></li><li><a class="tocitem" href="../../explanation/generators/probe/">PROBE</a></li><li><a class="tocitem" href="../../explanation/generators/revise/">REVISE</a></li></ul></li><li><input class="collapse-toggle" id="menuitem-3-4" type="checkbox"/><label class="tocitem" for="menuitem-3-4"><span class="docs-label">Optimisers</span><i class="docs-chevron"></i></label><ul class="collapsed"><li><a class="tocitem" href="../../explanation/optimisers/overview/">Overview</a></li><li><a class="tocitem" href="../../explanation/optimisers/jsma/">JSMA</a></li></ul></li><li><a class="tocitem" href="../../explanation/categorical/">Categorical Features</a></li></ul></li><li><span class="tocitem">ü´° How-To ...</span><ul><li><a class="tocitem" href="../">Overview</a></li><li><a class="tocitem" href="../custom_generators/">... add custom generators</a></li><li class="is-active"><a class="tocitem" href>... add custom models</a><ul class="internal"><li><a class="tocitem" href="#Custom-Models"><span>Custom Models</span></a></li><li><a class="tocitem" href="#References"><span>References</span></a></li></ul></li></ul></li><li><span class="tocitem">‚õìÔ∏è Extensions</span><ul><li><a class="tocitem" href="../../extensions/">Overview</a></li><li><a class="tocitem" href="../../extensions/neurotree/">NeuroTrees</a></li><li><a class="tocitem" href="../../extensions/laplace_redux/">LaplaceRedux</a></li></ul></li><li><a class="tocitem" href="../../reference/">üßê Reference</a></li><li><a class="tocitem" href="../../contribute/">üõ† Contribute</a></li><li><a class="tocitem" href="../../assets/resources/">üìö Additional Resources</a></li></ul><div class="docs-version-selector field has-addons"><div class="control"><span class="docs-label button is-static is-size-7">Version</span></div><div class="docs-selector control is-expanded"><div class="select is-fullwidth is-size-7"><select id="documenter-version-selector"></select></div></div></div></nav><div class="docs-main"><header class="docs-navbar"><a class="docs-sidebar-button docs-navbar-link fa-solid fa-bars is-hidden-desktop" id="documenter-sidebar-button" href="#"></a><nav class="breadcrumb"><ul class="is-hidden-mobile"><li><a class="is-disabled">ü´° How-To ...</a></li><li class="is-active"><a href>... add custom models</a></li></ul><ul class="is-hidden-tablet"><li class="is-active"><a href>... add custom models</a></li></ul></nav><div class="docs-right"><a class="docs-navbar-link" href="https://github.com/juliatrustworthyai/CounterfactualExplanations.jl/blob/main/docs/src/how_to_guides/custom_models.md#" title="Edit source on GitHub"><span class="docs-icon fa-solid">ÔÅÑ</span></a><a class="docs-settings-button docs-navbar-link fa-solid fa-gear" id="documenter-settings-button" href="#" title="Settings"></a><a class="docs-article-toggle-button fa-solid fa-chevron-up" id="documenter-article-toggle-button" href="javascript:;" title="Collapse all docstrings"></a></div></header><article class="content" id="documenter-page"><h1 id="How-to-add-Custom-Models"><a class="docs-heading-anchor" href="#How-to-add-Custom-Models">How to add Custom Models</a><a id="How-to-add-Custom-Models-1"></a><a class="docs-heading-anchor-permalink" href="#How-to-add-Custom-Models" title="Permalink"></a></h1><p>Adding custom models is possible and relatively straightforward, as we will demonstrate in this guide.</p><h2 id="Custom-Models"><a class="docs-heading-anchor" href="#Custom-Models">Custom Models</a><a id="Custom-Models-1"></a><a class="docs-heading-anchor-permalink" href="#Custom-Models" title="Permalink"></a></h2><p>Apart from the default models you can use any arbitrary (differentiable) model and generate recourse in the same way as before. Only two steps are necessary to make your own Julia model compatible with this package:</p><ol><li>The model needs to be declared as a subtype of <code>&lt;:CounterfactualExplanations.Models.AbstractFittedModel</code>.</li><li>You need to extend the functions <code>CounterfactualExplanations.Models.logits</code> and <code>CounterfactualExplanations.Models.probs</code> for your custom model.</li></ol><h3 id="How-FluxModel-was-added"><a class="docs-heading-anchor" href="#How-FluxModel-was-added">How <code>FluxModel</code> was added</a><a id="How-FluxModel-was-added-1"></a><a class="docs-heading-anchor-permalink" href="#How-FluxModel-was-added" title="Permalink"></a></h3><p>To demonstrate how this can be done in practice, we will reiterate here how native support for <a href="https://fluxml.ai/"><code>Flux.jl</code></a> models was enabled (Innes 2018). Once again we use synthetic data for an illustrative example. The code below loads the data and builds a simple model architecture that can be used for a multi-class prediction task. Note how outputs from the final layer are not passed through a softmax activation function, since the counterfactual loss is evaluated with respect to logits. The model is trained with dropout.</p><pre><code class="language-julia hljs"># Data:
N = 200
data = TaijaData.load_blobs(N; centers=4, cluster_std=0.5)
counterfactual_data = DataPreprocessing.CounterfactualData(data...)
y = counterfactual_data.y
X = counterfactual_data.X

# Flux model setup: 
using Flux
data = Flux.DataLoader((X,y), batchsize=1)
n_hidden = 32
output_dim = size(y,1)
input_dim = 2
activation = œÉ
model = Chain(
    Dense(input_dim, n_hidden, activation),
    Dropout(0.1),
    Dense(n_hidden, output_dim)
)  
loss(x, y) = Flux.Losses.logitcrossentropy(model(x), y)

# Flux model training:
using Flux.Optimise: update!, Adam
opt = Adam()
epochs = 50
for epoch = 1:epochs
  for d in data
    gs = gradient(Flux.params(model)) do
      l = loss(d...)
    end
    update!(opt, Flux.params(model), gs)
  end
end</code></pre><p>The code below implements the two steps that were necessary to make Flux models compatible with the package. We first declare our new struct as a subtype of <code>&lt;:AbstractDifferentiableModel</code>, which itself is an abstract subtype of <code>&lt;:AbstractFittedModel</code>. Computing logits amounts to just calling the model on inputs. Predicted probabilities for labels can in this case be computed by passing predicted logits through the softmax function. Finally, we just instantiate our model in the same way as always.</p><pre><code class="language-julia hljs"># Step 1)
struct MyFluxModel &lt;: AbstractDifferentiableModel
    model::Any
    likelihood::Symbol
end

# Step 2)
# import functions in order to extend
import CounterfactualExplanations.Models: logits
import CounterfactualExplanations.Models: probs 
logits(M::MyFluxModel, X::AbstractArray) = M.model(X)
probs(M::MyFluxModel, X::AbstractArray) = softmax(logits(M, X))
M = MyFluxModel(model, :classification_multi)</code></pre><p>The code below implements the counterfactual search and plots the results:</p><pre><code class="language-julia hljs">factual_label = 4
target = 2
chosen = rand(findall(predict_label(M, counterfactual_data) .== factual_label))
x = select_factual(counterfactual_data, chosen)  

# Counterfactual search:
generator = GenericGenerator()
ce = generate_counterfactual(x, target, counterfactual_data, M, generator)
plot(ce)</code></pre><p><img src="../custom_models_files/figure-commonmark/cell-5-output-1.svg" alt/></p><h2 id="References"><a class="docs-heading-anchor" href="#References">References</a><a id="References-1"></a><a class="docs-heading-anchor-permalink" href="#References" title="Permalink"></a></h2><p>Innes, Mike. 2018. ‚ÄúFlux: Elegant Machine Learning with Julia.‚Äù <em>Journal of Open Source Software</em> 3 (25): 602. <a href="https://doi.org/10.21105/joss.00602">https://doi.org/10.21105/joss.00602</a>.</p></article><nav class="docs-footer"><a class="docs-footer-prevpage" href="../custom_generators/">¬´ ... add custom generators</a><a class="docs-footer-nextpage" href="../../extensions/">Overview ¬ª</a><div class="flexbox-break"></div><p class="footer-message">Powered by <a href="https://github.com/JuliaDocs/Documenter.jl">Documenter.jl</a> and the <a href="https://julialang.org/">Julia Programming Language</a>.</p></nav></div><div class="modal" id="documenter-settings"><div class="modal-background"></div><div class="modal-card"><header class="modal-card-head"><p class="modal-card-title">Settings</p><button class="delete"></button></header><section class="modal-card-body"><p><label class="label">Theme</label><div class="select"><select id="documenter-themepicker"><option value="auto">Automatic (OS)</option><option value="documenter-light">documenter-light</option><option value="documenter-dark">documenter-dark</option></select></div></p><hr/><p>This document was generated with <a href="https://github.com/JuliaDocs/Documenter.jl">Documenter.jl</a> version 1.3.0 on <span class="colophon-date" title="Friday 12 April 2024 13:06">Friday 12 April 2024</span>. Using Julia version 1.10.2.</p></section><footer class="modal-card-foot"></footer></div></div></div></body></html>
