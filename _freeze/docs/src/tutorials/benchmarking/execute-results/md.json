{
  "hash": "1be7cb00ee8cf13c8fd323f3d0f720cc",
  "result": {
    "engine": "jupyter",
    "markdown": "---\nexecute: \n  output: true\n---\n\n``` @meta\nCurrentModule = CounterfactualExplanations \n```\n\n\n\n# Performance Benchmarks\n\nIn the previous tutorial, we have seen how counterfactual explanations can be evaluated. An important follow-up task is to compare the performance of different counterfactual generators is an important task. Researchers can use benchmarks to test new ideas they want to implement. Practitioners can find the right counterfactual generator for their specific use case through benchmarks. In this tutorial, we will see how to run benchmarks for counterfactual generators.\n\n## Post Hoc Benchmarking\n\nWe begin by continuing the discussion from the previous tutorial: suppose you have generated multiple counterfactual explanations for multiple individuals, like below:\n\n::: {.cell execution_count=2}\n``` {.julia .cell-code}\n# Factual and target:\nn_individuals = 5\nids = rand(findall(predict_label(M, counterfactual_data) .== factual), n_individuals)\nxs = select_factual(counterfactual_data, ids)\nces = generate_counterfactual(xs, target, counterfactual_data, M, generator; num_counterfactuals=5)\n```\n:::\n\n\nYou may be interested in comparing the outcomes across individuals. To benchmark the various counterfactual explanations using default evaluation measures, you can simply proceed as follows:\n\n::: {.cell execution_count=3}\n``` {.julia .cell-code}\nbmk = benchmark(ces)\n```\n:::\n\n\nUnder the hood, the [`benchmark(counterfactual_explanations::Vector{CounterfactualExplanation})`](@ref) uses [`evaluate(counterfactual_explanations::Vector{CounterfactualExplanation})`](@ref) to generate a [`Benchmark`](@ref) object, which contains the evaluation in its most granular form as a `DataFrame`.\n\n### Working with `Benchmark`s\n\nFor convenience, the `DataFrame` containing the evaluation can be returned by simply calling the `Benchmark` object. By default, the aggregated evaluation measures across `id` (in line with the default behaviour of `evaluate`).\n\n::: {.cell execution_count=4}\n``` {.julia .cell-code}\nbmk()\n```\n\n::: {.cell-output .cell-output-display .cell-output-markdown execution_count=5}\n\\begin{tabular}{r|ccccc}\n\t& sample & variable & value & generator & \\\\\n\t\\hline\n\t& Base.UUID & String & Float64 & Symbol & \\\\\n\t\\hline\n\t1 & 4d870646-f4c2-11ee-2da2-038400ab9389 & distance & 3.17243 & GradientBasedGenerator(nothing, CounterfactualExplanations.Objectives.distance\\_l1, 0.1, false, false, Descent(0.1), NamedTuple()) & $\\dots$ \\\\\n\t2 & 4d870646-f4c2-11ee-2da2-038400ab9389 & redundancy & 0.0 & GradientBasedGenerator(nothing, CounterfactualExplanations.Objectives.distance\\_l1, 0.1, false, false, Descent(0.1), NamedTuple()) & $\\dots$ \\\\\n\t3 & 4d870646-f4c2-11ee-2da2-038400ab9389 & validity & 1.0 & GradientBasedGenerator(nothing, CounterfactualExplanations.Objectives.distance\\_l1, 0.1, false, false, Descent(0.1), NamedTuple()) & $\\dots$ \\\\\n\t4 & 4d8e474e-f4c2-11ee-20a0-271d06823dfc & distance & 3.07148 & GradientBasedGenerator(nothing, CounterfactualExplanations.Objectives.distance\\_l1, 0.1, false, false, Descent(0.1), NamedTuple()) & $\\dots$ \\\\\n\t5 & 4d8e474e-f4c2-11ee-20a0-271d06823dfc & redundancy & 0.0 & GradientBasedGenerator(nothing, CounterfactualExplanations.Objectives.distance\\_l1, 0.1, false, false, Descent(0.1), NamedTuple()) & $\\dots$ \\\\\n\t6 & 4d8e474e-f4c2-11ee-20a0-271d06823dfc & validity & 1.0 & GradientBasedGenerator(nothing, CounterfactualExplanations.Objectives.distance\\_l1, 0.1, false, false, Descent(0.1), NamedTuple()) & $\\dots$ \\\\\n\t7 & 4d8e4c80-f4c2-11ee-1287-81610e5fb51c & distance & 3.62159 & GradientBasedGenerator(nothing, CounterfactualExplanations.Objectives.distance\\_l1, 0.1, false, false, Descent(0.1), NamedTuple()) & $\\dots$ \\\\\n\t8 & 4d8e4c80-f4c2-11ee-1287-81610e5fb51c & redundancy & 0.0 & GradientBasedGenerator(nothing, CounterfactualExplanations.Objectives.distance\\_l1, 0.1, false, false, Descent(0.1), NamedTuple()) & $\\dots$ \\\\\n\t9 & 4d8e4c80-f4c2-11ee-1287-81610e5fb51c & validity & 1.0 & GradientBasedGenerator(nothing, CounterfactualExplanations.Objectives.distance\\_l1, 0.1, false, false, Descent(0.1), NamedTuple()) & $\\dots$ \\\\\n\t10 & 4d8e5068-f4c2-11ee-11cc-193c402ab999 & distance & 2.62783 & GradientBasedGenerator(nothing, CounterfactualExplanations.Objectives.distance\\_l1, 0.1, false, false, Descent(0.1), NamedTuple()) & $\\dots$ \\\\\n\t11 & 4d8e5068-f4c2-11ee-11cc-193c402ab999 & redundancy & 0.0 & GradientBasedGenerator(nothing, CounterfactualExplanations.Objectives.distance\\_l1, 0.1, false, false, Descent(0.1), NamedTuple()) & $\\dots$ \\\\\n\t12 & 4d8e5068-f4c2-11ee-11cc-193c402ab999 & validity & 1.0 & GradientBasedGenerator(nothing, CounterfactualExplanations.Objectives.distance\\_l1, 0.1, false, false, Descent(0.1), NamedTuple()) & $\\dots$ \\\\\n\t13 & 4d8e53f6-f4c2-11ee-2cd8-d5ee288aa79f & distance & 2.91985 & GradientBasedGenerator(nothing, CounterfactualExplanations.Objectives.distance\\_l1, 0.1, false, false, Descent(0.1), NamedTuple()) & $\\dots$ \\\\\n\t14 & 4d8e53f6-f4c2-11ee-2cd8-d5ee288aa79f & redundancy & 0.0 & GradientBasedGenerator(nothing, CounterfactualExplanations.Objectives.distance\\_l1, 0.1, false, false, Descent(0.1), NamedTuple()) & $\\dots$ \\\\\n\t15 & 4d8e53f6-f4c2-11ee-2cd8-d5ee288aa79f & validity & 1.0 & GradientBasedGenerator(nothing, CounterfactualExplanations.Objectives.distance\\_l1, 0.1, false, false, Descent(0.1), NamedTuple()) & $\\dots$ \\\\\n\\end{tabular}\n\n:::\n:::\n\n\n::: {.cell execution_count=5}\n\n::: {.cell-output .cell-output-stdout}\n```\n15×7 DataFrame\n Row │ sample                                variable    value    generator    ⋯\n     │ Base.UUID                             String      Float64  Symbol       ⋯\n─────┼──────────────────────────────────────────────────────────────────────────\n   1 │ 4d870646-f4c2-11ee-2da2-038400ab9389  distance    3.17243  GradientBase ⋯\n   2 │ 4d870646-f4c2-11ee-2da2-038400ab9389  redundancy  0.0      GradientBase\n   3 │ 4d870646-f4c2-11ee-2da2-038400ab9389  validity    1.0      GradientBase\n   4 │ 4d8e474e-f4c2-11ee-20a0-271d06823dfc  distance    3.07148  GradientBase\n   5 │ 4d8e474e-f4c2-11ee-20a0-271d06823dfc  redundancy  0.0      GradientBase ⋯\n   6 │ 4d8e474e-f4c2-11ee-20a0-271d06823dfc  validity    1.0      GradientBase\n   7 │ 4d8e4c80-f4c2-11ee-1287-81610e5fb51c  distance    3.62159  GradientBase\n   8 │ 4d8e4c80-f4c2-11ee-1287-81610e5fb51c  redundancy  0.0      GradientBase\n   9 │ 4d8e4c80-f4c2-11ee-1287-81610e5fb51c  validity    1.0      GradientBase ⋯\n  10 │ 4d8e5068-f4c2-11ee-11cc-193c402ab999  distance    2.62783  GradientBase\n  11 │ 4d8e5068-f4c2-11ee-11cc-193c402ab999  redundancy  0.0      GradientBase\n  12 │ 4d8e5068-f4c2-11ee-11cc-193c402ab999  validity    1.0      GradientBase\n  13 │ 4d8e53f6-f4c2-11ee-2cd8-d5ee288aa79f  distance    2.91985  GradientBase ⋯\n  14 │ 4d8e53f6-f4c2-11ee-2cd8-d5ee288aa79f  redundancy  0.0      GradientBase\n  15 │ 4d8e53f6-f4c2-11ee-2cd8-d5ee288aa79f  validity    1.0      GradientBase\n                                                               4 columns omitted\n```\n:::\n:::\n\n\nTo retrieve the granular dataset, simply do:\n\n::: {.cell execution_count=6}\n``` {.julia .cell-code}\nbmk(agg=nothing)\n```\n\n::: {.cell-output .cell-output-display .cell-output-markdown execution_count=7}\n\\begin{tabular}{r|cccccc}\n\t& sample & num\\_counterfactual & variable & value & generator & \\\\\n\t\\hline\n\t& Base.UUID & Int64 & String & Float64 & Symbol & \\\\\n\t\\hline\n\t1 & 4d870646-f4c2-11ee-2da2-038400ab9389 & 1 & distance & 3.15903 & GradientBasedGenerator(nothing, CounterfactualExplanations.Objectives.distance\\_l1, 0.1, false, false, Descent(0.1), NamedTuple()) & $\\dots$ \\\\\n\t2 & 4d870646-f4c2-11ee-2da2-038400ab9389 & 2 & distance & 3.16773 & GradientBasedGenerator(nothing, CounterfactualExplanations.Objectives.distance\\_l1, 0.1, false, false, Descent(0.1), NamedTuple()) & $\\dots$ \\\\\n\t3 & 4d870646-f4c2-11ee-2da2-038400ab9389 & 3 & distance & 3.17011 & GradientBasedGenerator(nothing, CounterfactualExplanations.Objectives.distance\\_l1, 0.1, false, false, Descent(0.1), NamedTuple()) & $\\dots$ \\\\\n\t4 & 4d870646-f4c2-11ee-2da2-038400ab9389 & 4 & distance & 3.20239 & GradientBasedGenerator(nothing, CounterfactualExplanations.Objectives.distance\\_l1, 0.1, false, false, Descent(0.1), NamedTuple()) & $\\dots$ \\\\\n\t5 & 4d870646-f4c2-11ee-2da2-038400ab9389 & 5 & distance & 3.16291 & GradientBasedGenerator(nothing, CounterfactualExplanations.Objectives.distance\\_l1, 0.1, false, false, Descent(0.1), NamedTuple()) & $\\dots$ \\\\\n\t6 & 4d870646-f4c2-11ee-2da2-038400ab9389 & 1 & redundancy & 0.0 & GradientBasedGenerator(nothing, CounterfactualExplanations.Objectives.distance\\_l1, 0.1, false, false, Descent(0.1), NamedTuple()) & $\\dots$ \\\\\n\t7 & 4d870646-f4c2-11ee-2da2-038400ab9389 & 2 & redundancy & 0.0 & GradientBasedGenerator(nothing, CounterfactualExplanations.Objectives.distance\\_l1, 0.1, false, false, Descent(0.1), NamedTuple()) & $\\dots$ \\\\\n\t8 & 4d870646-f4c2-11ee-2da2-038400ab9389 & 3 & redundancy & 0.0 & GradientBasedGenerator(nothing, CounterfactualExplanations.Objectives.distance\\_l1, 0.1, false, false, Descent(0.1), NamedTuple()) & $\\dots$ \\\\\n\t9 & 4d870646-f4c2-11ee-2da2-038400ab9389 & 4 & redundancy & 0.0 & GradientBasedGenerator(nothing, CounterfactualExplanations.Objectives.distance\\_l1, 0.1, false, false, Descent(0.1), NamedTuple()) & $\\dots$ \\\\\n\t10 & 4d870646-f4c2-11ee-2da2-038400ab9389 & 5 & redundancy & 0.0 & GradientBasedGenerator(nothing, CounterfactualExplanations.Objectives.distance\\_l1, 0.1, false, false, Descent(0.1), NamedTuple()) & $\\dots$ \\\\\n\t11 & 4d870646-f4c2-11ee-2da2-038400ab9389 & 1 & validity & 1.0 & GradientBasedGenerator(nothing, CounterfactualExplanations.Objectives.distance\\_l1, 0.1, false, false, Descent(0.1), NamedTuple()) & $\\dots$ \\\\\n\t12 & 4d870646-f4c2-11ee-2da2-038400ab9389 & 2 & validity & 1.0 & GradientBasedGenerator(nothing, CounterfactualExplanations.Objectives.distance\\_l1, 0.1, false, false, Descent(0.1), NamedTuple()) & $\\dots$ \\\\\n\t13 & 4d870646-f4c2-11ee-2da2-038400ab9389 & 3 & validity & 1.0 & GradientBasedGenerator(nothing, CounterfactualExplanations.Objectives.distance\\_l1, 0.1, false, false, Descent(0.1), NamedTuple()) & $\\dots$ \\\\\n\t14 & 4d870646-f4c2-11ee-2da2-038400ab9389 & 4 & validity & 1.0 & GradientBasedGenerator(nothing, CounterfactualExplanations.Objectives.distance\\_l1, 0.1, false, false, Descent(0.1), NamedTuple()) & $\\dots$ \\\\\n\t15 & 4d870646-f4c2-11ee-2da2-038400ab9389 & 5 & validity & 1.0 & GradientBasedGenerator(nothing, CounterfactualExplanations.Objectives.distance\\_l1, 0.1, false, false, Descent(0.1), NamedTuple()) & $\\dots$ \\\\\n\t16 & 4d8e474e-f4c2-11ee-20a0-271d06823dfc & 1 & distance & 3.02225 & GradientBasedGenerator(nothing, CounterfactualExplanations.Objectives.distance\\_l1, 0.1, false, false, Descent(0.1), NamedTuple()) & $\\dots$ \\\\\n\t17 & 4d8e474e-f4c2-11ee-20a0-271d06823dfc & 2 & distance & 3.01539 & GradientBasedGenerator(nothing, CounterfactualExplanations.Objectives.distance\\_l1, 0.1, false, false, Descent(0.1), NamedTuple()) & $\\dots$ \\\\\n\t18 & 4d8e474e-f4c2-11ee-20a0-271d06823dfc & 3 & distance & 3.00694 & GradientBasedGenerator(nothing, CounterfactualExplanations.Objectives.distance\\_l1, 0.1, false, false, Descent(0.1), NamedTuple()) & $\\dots$ \\\\\n\t19 & 4d8e474e-f4c2-11ee-20a0-271d06823dfc & 4 & distance & 3.15326 & GradientBasedGenerator(nothing, CounterfactualExplanations.Objectives.distance\\_l1, 0.1, false, false, Descent(0.1), NamedTuple()) & $\\dots$ \\\\\n\t20 & 4d8e474e-f4c2-11ee-20a0-271d06823dfc & 5 & distance & 3.15957 & GradientBasedGenerator(nothing, CounterfactualExplanations.Objectives.distance\\_l1, 0.1, false, false, Descent(0.1), NamedTuple()) & $\\dots$ \\\\\n\t21 & 4d8e474e-f4c2-11ee-20a0-271d06823dfc & 1 & redundancy & 0.0 & GradientBasedGenerator(nothing, CounterfactualExplanations.Objectives.distance\\_l1, 0.1, false, false, Descent(0.1), NamedTuple()) & $\\dots$ \\\\\n\t22 & 4d8e474e-f4c2-11ee-20a0-271d06823dfc & 2 & redundancy & 0.0 & GradientBasedGenerator(nothing, CounterfactualExplanations.Objectives.distance\\_l1, 0.1, false, false, Descent(0.1), NamedTuple()) & $\\dots$ \\\\\n\t23 & 4d8e474e-f4c2-11ee-20a0-271d06823dfc & 3 & redundancy & 0.0 & GradientBasedGenerator(nothing, CounterfactualExplanations.Objectives.distance\\_l1, 0.1, false, false, Descent(0.1), NamedTuple()) & $\\dots$ \\\\\n\t24 & 4d8e474e-f4c2-11ee-20a0-271d06823dfc & 4 & redundancy & 0.0 & GradientBasedGenerator(nothing, CounterfactualExplanations.Objectives.distance\\_l1, 0.1, false, false, Descent(0.1), NamedTuple()) & $\\dots$ \\\\\n\t25 & 4d8e474e-f4c2-11ee-20a0-271d06823dfc & 5 & redundancy & 0.0 & GradientBasedGenerator(nothing, CounterfactualExplanations.Objectives.distance\\_l1, 0.1, false, false, Descent(0.1), NamedTuple()) & $\\dots$ \\\\\n\t26 & 4d8e474e-f4c2-11ee-20a0-271d06823dfc & 1 & validity & 1.0 & GradientBasedGenerator(nothing, CounterfactualExplanations.Objectives.distance\\_l1, 0.1, false, false, Descent(0.1), NamedTuple()) & $\\dots$ \\\\\n\t27 & 4d8e474e-f4c2-11ee-20a0-271d06823dfc & 2 & validity & 1.0 & GradientBasedGenerator(nothing, CounterfactualExplanations.Objectives.distance\\_l1, 0.1, false, false, Descent(0.1), NamedTuple()) & $\\dots$ \\\\\n\t28 & 4d8e474e-f4c2-11ee-20a0-271d06823dfc & 3 & validity & 1.0 & GradientBasedGenerator(nothing, CounterfactualExplanations.Objectives.distance\\_l1, 0.1, false, false, Descent(0.1), NamedTuple()) & $\\dots$ \\\\\n\t29 & 4d8e474e-f4c2-11ee-20a0-271d06823dfc & 4 & validity & 1.0 & GradientBasedGenerator(nothing, CounterfactualExplanations.Objectives.distance\\_l1, 0.1, false, false, Descent(0.1), NamedTuple()) & $\\dots$ \\\\\n\t30 & 4d8e474e-f4c2-11ee-20a0-271d06823dfc & 5 & validity & 1.0 & GradientBasedGenerator(nothing, CounterfactualExplanations.Objectives.distance\\_l1, 0.1, false, false, Descent(0.1), NamedTuple()) & $\\dots$ \\\\\n\t$\\dots$ & $\\dots$ & $\\dots$ & $\\dots$ & $\\dots$ & $\\dots$ &  \\\\\n\\end{tabular}\n\n:::\n:::\n\n\n::: {.cell execution_count=7}\n\n::: {.cell-output .cell-output-stdout}\n```\n75×8 DataFrame\n Row │ sample                                num_counterfactual  variable    v ⋯\n     │ Base.UUID                             Int64               String      F ⋯\n─────┼──────────────────────────────────────────────────────────────────────────\n   1 │ 4d870646-f4c2-11ee-2da2-038400ab9389                   1  distance    3 ⋯\n   2 │ 4d870646-f4c2-11ee-2da2-038400ab9389                   2  distance    3\n   3 │ 4d870646-f4c2-11ee-2da2-038400ab9389                   3  distance    3\n   4 │ 4d870646-f4c2-11ee-2da2-038400ab9389                   4  distance    3\n   5 │ 4d870646-f4c2-11ee-2da2-038400ab9389                   5  distance    3 ⋯\n   6 │ 4d870646-f4c2-11ee-2da2-038400ab9389                   1  redundancy  0\n   7 │ 4d870646-f4c2-11ee-2da2-038400ab9389                   2  redundancy  0\n   8 │ 4d870646-f4c2-11ee-2da2-038400ab9389                   3  redundancy  0\n   9 │ 4d870646-f4c2-11ee-2da2-038400ab9389                   4  redundancy  0 ⋯\n  10 │ 4d870646-f4c2-11ee-2da2-038400ab9389                   5  redundancy  0\n  11 │ 4d870646-f4c2-11ee-2da2-038400ab9389                   1  validity    1\n  ⋮  │                  ⋮                            ⋮               ⋮         ⋱\n  66 │ 4d8e53f6-f4c2-11ee-2cd8-d5ee288aa79f                   1  redundancy  0\n  67 │ 4d8e53f6-f4c2-11ee-2cd8-d5ee288aa79f                   2  redundancy  0 ⋯\n  68 │ 4d8e53f6-f4c2-11ee-2cd8-d5ee288aa79f                   3  redundancy  0\n  69 │ 4d8e53f6-f4c2-11ee-2cd8-d5ee288aa79f                   4  redundancy  0\n  70 │ 4d8e53f6-f4c2-11ee-2cd8-d5ee288aa79f                   5  redundancy  0\n  71 │ 4d8e53f6-f4c2-11ee-2cd8-d5ee288aa79f                   1  validity    1 ⋯\n  72 │ 4d8e53f6-f4c2-11ee-2cd8-d5ee288aa79f                   2  validity    1\n  73 │ 4d8e53f6-f4c2-11ee-2cd8-d5ee288aa79f                   3  validity    1\n  74 │ 4d8e53f6-f4c2-11ee-2cd8-d5ee288aa79f                   4  validity    1\n  75 │ 4d8e53f6-f4c2-11ee-2cd8-d5ee288aa79f                   5  validity    1 ⋯\n                                                   5 columns and 54 rows omitted\n```\n:::\n:::\n\n\nSince benchmarks return a `DataFrame` object on call, post-processing is straightforward. For example, we could use [`Tidier.jl`](https://kdpsingh.github.io/Tidier.jl/dev/):\n\n::: {.cell execution_count=8}\n``` {.julia .cell-code}\nusing Tidier\n@chain bmk() begin\n    @filter(variable == \"distance\")\n    @select(sample, variable, value)\nend\n```\n\n::: {.cell-output .cell-output-display .cell-output-markdown execution_count=9}\n\\begin{tabular}{r|ccc}\n\t& sample & variable & value\\\\\n\t\\hline\n\t& Base.UUID & String & Float64\\\\\n\t\\hline\n\t1 & 4d870646-f4c2-11ee-2da2-038400ab9389 & distance & 3.17243 \\\\\n\t2 & 4d8e474e-f4c2-11ee-20a0-271d06823dfc & distance & 3.07148 \\\\\n\t3 & 4d8e4c80-f4c2-11ee-1287-81610e5fb51c & distance & 3.62159 \\\\\n\t4 & 4d8e5068-f4c2-11ee-11cc-193c402ab999 & distance & 2.62783 \\\\\n\t5 & 4d8e53f6-f4c2-11ee-2cd8-d5ee288aa79f & distance & 2.91985 \\\\\n\\end{tabular}\n\n:::\n:::\n\n\n::: {.cell execution_count=9}\n\n::: {.cell-output .cell-output-stdout}\n```\n5×3 DataFrame\n Row │ sample                                variable  value   \n     │ Base.UUID                             String    Float64 \n─────┼─────────────────────────────────────────────────────────\n   1 │ 4d870646-f4c2-11ee-2da2-038400ab9389  distance  3.17243\n   2 │ 4d8e474e-f4c2-11ee-20a0-271d06823dfc  distance  3.07148\n   3 │ 4d8e4c80-f4c2-11ee-1287-81610e5fb51c  distance  3.62159\n   4 │ 4d8e5068-f4c2-11ee-11cc-193c402ab999  distance  2.62783\n   5 │ 4d8e53f6-f4c2-11ee-2cd8-d5ee288aa79f  distance  2.91985\n```\n:::\n:::\n\n\n### Metadata for Counterfactual Explanations\n\nBenchmarks always report metadata for each counterfactual explanation, which is automatically inferred by default. The default metadata concerns the explained `model` and the employed `generator`. In the current example, we used the same model and generator for each individual:\n\n::: {.cell execution_count=10}\n``` {.julia .cell-code}\n@chain bmk() begin\n    @group_by(sample)\n    @select(sample, model, generator)\n    @summarize(model=first(model),generator=first(generator))\n    @ungroup\nend\n```\n\n::: {.cell-output .cell-output-display .cell-output-markdown execution_count=11}\n\\begin{tabular}{r|ccc}\n\t& sample & model & \\\\\n\t\\hline\n\t& Base.UUID & Symbol & \\\\\n\t\\hline\n\t1 & 4d870646-f4c2-11ee-2da2-038400ab9389 & FluxModel(Chain(Dense(2 => 2)), :classification\\_multi) & $\\dots$ \\\\\n\t2 & 4d8e474e-f4c2-11ee-20a0-271d06823dfc & FluxModel(Chain(Dense(2 => 2)), :classification\\_multi) & $\\dots$ \\\\\n\t3 & 4d8e4c80-f4c2-11ee-1287-81610e5fb51c & FluxModel(Chain(Dense(2 => 2)), :classification\\_multi) & $\\dots$ \\\\\n\t4 & 4d8e5068-f4c2-11ee-11cc-193c402ab999 & FluxModel(Chain(Dense(2 => 2)), :classification\\_multi) & $\\dots$ \\\\\n\t5 & 4d8e53f6-f4c2-11ee-2cd8-d5ee288aa79f & FluxModel(Chain(Dense(2 => 2)), :classification\\_multi) & $\\dots$ \\\\\n\\end{tabular}\n\n:::\n:::\n\n\n::: {.cell execution_count=11}\n\n::: {.cell-output .cell-output-stdout}\n```\n5×3 DataFrame\n Row │ sample                                model                             ⋯\n     │ Base.UUID                             Symbol                            ⋯\n─────┼──────────────────────────────────────────────────────────────────────────\n   1 │ 4d870646-f4c2-11ee-2da2-038400ab9389  FluxModel(Chain(Dense(2 => 2)), … ⋯\n   2 │ 4d8e474e-f4c2-11ee-20a0-271d06823dfc  FluxModel(Chain(Dense(2 => 2)), …\n   3 │ 4d8e4c80-f4c2-11ee-1287-81610e5fb51c  FluxModel(Chain(Dense(2 => 2)), …\n   4 │ 4d8e5068-f4c2-11ee-11cc-193c402ab999  FluxModel(Chain(Dense(2 => 2)), …\n   5 │ 4d8e53f6-f4c2-11ee-2cd8-d5ee288aa79f  FluxModel(Chain(Dense(2 => 2)), … ⋯\n                                                                1 column omitted\n```\n:::\n:::\n\n\nMetadata can also be provided as an optional key argument.\n\n::: {.cell execution_count=12}\n``` {.julia .cell-code}\nmeta_data = Dict(\n    :generator => \"Generic\",\n    :model => \"MLP\",\n)\nmeta_data = [meta_data for i in 1:length(ces)]\nbmk = benchmark(ces; meta_data=meta_data)\n@chain bmk() begin\n    @group_by(sample)\n    @select(sample, model, generator)\n    @summarize(model=first(model),generator=first(generator))\n    @ungroup\nend\n```\n\n::: {.cell-output .cell-output-display .cell-output-markdown execution_count=13}\n\\begin{tabular}{r|ccc}\n\t& sample & model & generator\\\\\n\t\\hline\n\t& Base.UUID & String & String\\\\\n\t\\hline\n\t1 & 51c54c68-f4c2-11ee-08c0-d9c30ebb747b & MLP & Generic \\\\\n\t2 & 51c838b0-f4c2-11ee-2d0c-0733278674ca & MLP & Generic \\\\\n\t3 & 51c83c84-f4c2-11ee-17ed-d9ba1ae239c3 & MLP & Generic \\\\\n\t4 & 51c83fea-f4c2-11ee-32bf-a552d6fa02bb & MLP & Generic \\\\\n\t5 & 51c842e2-f4c2-11ee-1ebf-ed383d576cc8 & MLP & Generic \\\\\n\\end{tabular}\n\n:::\n:::\n\n\n::: {.cell execution_count=13}\n\n::: {.cell-output .cell-output-stdout}\n```\n5×3 DataFrame\n Row │ sample                                model   generator \n     │ Base.UUID                             String  String    \n─────┼─────────────────────────────────────────────────────────\n   1 │ 51c54c68-f4c2-11ee-08c0-d9c30ebb747b  MLP     Generic\n   2 │ 51c838b0-f4c2-11ee-2d0c-0733278674ca  MLP     Generic\n   3 │ 51c83c84-f4c2-11ee-17ed-d9ba1ae239c3  MLP     Generic\n   4 │ 51c83fea-f4c2-11ee-32bf-a552d6fa02bb  MLP     Generic\n   5 │ 51c842e2-f4c2-11ee-1ebf-ed383d576cc8  MLP     Generic\n```\n:::\n:::\n\n\n## Ad Hoc Benchmarking\n\nSo far we have assumed the following workflow:\n\n1.  Fit some machine learning model.\n2.  Generate counterfactual explanations for some individual(s) (`generate_counterfactual`).\n3.  Evaluate and benchmark them (`benchmark(ces::Vector{CounterfactualExplanation})`).\n\nIn many cases, it may be preferable to combine these steps. To this end, we have added support for two scenarios of Ad Hoc Benchmarking.\n\n### Pre-trained Models\n\nIn the first scenario, it is assumed that the machine learning models have been pre-trained and so the workflow can be summarized as follows:\n\n1.  Fit some machine learning model(s).\n2.  Generate counterfactual explanations and benchmark them.\n\nWe suspect that this is the most common workflow for practitioners who are interested in benchmarking counterfactual explanations for the pre-trained machine learning models. Let's go through this workflow using a simple example. We first train some models and store them in a dictionary:\n\n::: {.cell execution_count=14}\n``` {.julia .cell-code}\nmodels = Dict(\n    :MLP => fit_model(counterfactual_data, :MLP),\n    :Linear => fit_model(counterfactual_data, :Linear),\n)\n```\n:::\n\n\nNext, we store the counterfactual generators of interest in a dictionary as well:\n\n::: {.cell execution_count=15}\n``` {.julia .cell-code}\ngenerators = Dict(\n    :Generic => GenericGenerator(),\n    :Gravitational => GravitationalGenerator(),\n    :Wachter => WachterGenerator(),\n    :ClaPROAR => ClaPROARGenerator(),\n)\n```\n:::\n\n\nThen we can run a benchmark for individual(s) `x`, a pre-specified `target` and `counterfactual_data` as follows:\n\n::: {.cell execution_count=16}\n``` {.julia .cell-code}\nbmk = benchmark(x, target, counterfactual_data; models=models, generators=generators)\n```\n:::\n\n\nIn this case, metadata is automatically inferred from the dictionaries:\n\n::: {.cell execution_count=17}\n``` {.julia .cell-code}\n@chain bmk() begin\n    @filter(variable == \"distance\")\n    @select(sample, variable, value, model, generator)\nend\n```\n\n::: {.cell-output .cell-output-display .cell-output-markdown execution_count=18}\n\\begin{tabular}{r|ccccc}\n\t& sample & variable & value & model & \\\\\n\t\\hline\n\t& Base.UUID & String & Float64 & Tuple… & \\\\\n\t\\hline\n\t1 & 56537c94-f4c2-11ee-28a2-33f830cc2aeb & distance & 4.38877 & (:Linear, FluxModel(Chain(Dense(2 => 2)), :classification\\_multi)) & $\\dots$ \\\\\n\t2 & 566e1272-f4c2-11ee-3976-55aee61c911f & distance & 4.17021 & (:Linear, FluxModel(Chain(Dense(2 => 2)), :classification\\_multi)) & $\\dots$ \\\\\n\t3 & 566e1330-f4c2-11ee-22a2-916be39f526d & distance & 4.31145 & (:Linear, FluxModel(Chain(Dense(2 => 2)), :classification\\_multi)) & $\\dots$ \\\\\n\t4 & 566e135a-f4c2-11ee-0486-051aa65063ec & distance & 4.17035 & (:Linear, FluxModel(Chain(Dense(2 => 2)), :classification\\_multi)) & $\\dots$ \\\\\n\t5 & 566e1380-f4c2-11ee-2594-0f37b28bb409 & distance & 5.73182 & (:MLP, FluxModel(Chain(Dense(2 => 10, relu), Dense(10 => 2)), :classification\\_multi)) & $\\dots$ \\\\\n\t6 & 566e139e-f4c2-11ee-32a1-df1a7abb4111 & distance & 5.50606 & (:MLP, FluxModel(Chain(Dense(2 => 10, relu), Dense(10 => 2)), :classification\\_multi)) & $\\dots$ \\\\\n\t7 & 566e13ba-f4c2-11ee-1c05-81ec3ba1ff08 & distance & 5.2114 & (:MLP, FluxModel(Chain(Dense(2 => 10, relu), Dense(10 => 2)), :classification\\_multi)) & $\\dots$ \\\\\n\t8 & 566e13da-f4c2-11ee-07b0-61ef5fc9258a & distance & 5.3623 & (:MLP, FluxModel(Chain(Dense(2 => 10, relu), Dense(10 => 2)), :classification\\_multi)) & $\\dots$ \\\\\n\\end{tabular}\n\n:::\n:::\n\n\n::: {.cell execution_count=18}\n\n::: {.cell-output .cell-output-stdout}\n```\n8×5 DataFrame\n Row │ sample                                variable  value    model          ⋯\n     │ Base.UUID                             String    Float64  Tuple…         ⋯\n─────┼──────────────────────────────────────────────────────────────────────────\n   1 │ 56537c94-f4c2-11ee-28a2-33f830cc2aeb  distance  4.38877  (:Linear, Flux ⋯\n   2 │ 566e1272-f4c2-11ee-3976-55aee61c911f  distance  4.17021  (:Linear, Flux\n   3 │ 566e1330-f4c2-11ee-22a2-916be39f526d  distance  4.31145  (:Linear, Flux\n   4 │ 566e135a-f4c2-11ee-0486-051aa65063ec  distance  4.17035  (:Linear, Flux\n   5 │ 566e1380-f4c2-11ee-2594-0f37b28bb409  distance  5.73182  (:MLP, FluxMod ⋯\n   6 │ 566e139e-f4c2-11ee-32a1-df1a7abb4111  distance  5.50606  (:MLP, FluxMod\n   7 │ 566e13ba-f4c2-11ee-1c05-81ec3ba1ff08  distance  5.2114   (:MLP, FluxMod\n   8 │ 566e13da-f4c2-11ee-07b0-61ef5fc9258a  distance  5.3623   (:MLP, FluxMod\n                                                               2 columns omitted\n```\n:::\n:::\n\n\n### Everything at once\n\nResearchers, in particular, may be interested in combining all steps into one. This is the second scenario of Ad Hoc Benchmarking:\n\n1.  Fit some machine learning model(s), generate counterfactual explanations and benchmark them.\n\nIt involves calling `benchmark` directly on counterfactual data (the only positional argument):\n\n::: {.cell execution_count=19}\n``` {.julia .cell-code}\nbmk = benchmark(counterfactual_data)\n```\n:::\n\n\nThis will use the default models from [`standard_models_catalogue`](@ref) and train them on the data. All available generators from [`generator_catalogue`](@ref) will also be used:\n\n::: {.cell execution_count=20}\n``` {.julia .cell-code}\n@chain bmk() begin\n    @filter(variable == \"validity\")\n    @select(sample, variable, value, model, generator)\nend\n```\n\n::: {.cell-output .cell-output-display .cell-output-markdown execution_count=21}\n\\begin{tabular}{r|ccccc}\n\t& sample & variable & value & model & generator\\\\\n\t\\hline\n\t& Base.UUID & String & Float64 & Symbol & Symbol\\\\\n\t\\hline\n\t1 & 5c195b3c-f4c2-11ee-322a-9173776f3b7a & validity & 1.0 & Linear & gravitational \\\\\n\t2 & 5c195b3c-f4c2-11ee-322a-9173776f3b7a & validity & 1.0 & Linear & growing\\_spheres \\\\\n\t3 & 5c195b3c-f4c2-11ee-322a-9173776f3b7a & validity & 1.0 & Linear & revise \\\\\n\t4 & 5c195b3c-f4c2-11ee-322a-9173776f3b7a & validity & 1.0 & Linear & clue \\\\\n\t5 & 5c195b3c-f4c2-11ee-322a-9173776f3b7a & validity & 1.0 & Linear & probe \\\\\n\t6 & 5c195b3c-f4c2-11ee-322a-9173776f3b7a & validity & 1.0 & Linear & dice \\\\\n\t7 & 5c195b3c-f4c2-11ee-322a-9173776f3b7a & validity & 1.0 & Linear & claproar \\\\\n\t8 & 5c195b3c-f4c2-11ee-322a-9173776f3b7a & validity & 1.0 & Linear & wachter \\\\\n\t9 & 5c195b3c-f4c2-11ee-322a-9173776f3b7a & validity & 1.0 & Linear & generic \\\\\n\t10 & 5c195b3c-f4c2-11ee-322a-9173776f3b7a & validity & 1.0 & Linear & greedy \\\\\n\t11 & 5c1a277e-f4c2-11ee-0a8e-fb5f14a8e654 & validity & 1.0 & Linear & gravitational \\\\\n\t12 & 5c1a277e-f4c2-11ee-0a8e-fb5f14a8e654 & validity & 1.0 & Linear & growing\\_spheres \\\\\n\t13 & 5c1a277e-f4c2-11ee-0a8e-fb5f14a8e654 & validity & 1.0 & Linear & revise \\\\\n\t14 & 5c1a277e-f4c2-11ee-0a8e-fb5f14a8e654 & validity & 1.0 & Linear & clue \\\\\n\t15 & 5c1a277e-f4c2-11ee-0a8e-fb5f14a8e654 & validity & 1.0 & Linear & probe \\\\\n\t16 & 5c1a277e-f4c2-11ee-0a8e-fb5f14a8e654 & validity & 1.0 & Linear & dice \\\\\n\t17 & 5c1a277e-f4c2-11ee-0a8e-fb5f14a8e654 & validity & 1.0 & Linear & claproar \\\\\n\t18 & 5c1a277e-f4c2-11ee-0a8e-fb5f14a8e654 & validity & 1.0 & Linear & wachter \\\\\n\t19 & 5c1a277e-f4c2-11ee-0a8e-fb5f14a8e654 & validity & 1.0 & Linear & generic \\\\\n\t20 & 5c1a277e-f4c2-11ee-0a8e-fb5f14a8e654 & validity & 1.0 & Linear & greedy \\\\\n\t21 & 5c1a27b0-f4c2-11ee-2759-09e46006f0c0 & validity & 1.0 & Linear & gravitational \\\\\n\t22 & 5c1a27b0-f4c2-11ee-2759-09e46006f0c0 & validity & 1.0 & Linear & growing\\_spheres \\\\\n\t23 & 5c1a27b0-f4c2-11ee-2759-09e46006f0c0 & validity & 1.0 & Linear & revise \\\\\n\t24 & 5c1a27b0-f4c2-11ee-2759-09e46006f0c0 & validity & 1.0 & Linear & clue \\\\\n\t25 & 5c1a27b0-f4c2-11ee-2759-09e46006f0c0 & validity & 1.0 & Linear & probe \\\\\n\t26 & 5c1a27b0-f4c2-11ee-2759-09e46006f0c0 & validity & 1.0 & Linear & dice \\\\\n\t27 & 5c1a27b0-f4c2-11ee-2759-09e46006f0c0 & validity & 1.0 & Linear & claproar \\\\\n\t28 & 5c1a27b0-f4c2-11ee-2759-09e46006f0c0 & validity & 1.0 & Linear & wachter \\\\\n\t29 & 5c1a27b0-f4c2-11ee-2759-09e46006f0c0 & validity & 1.0 & Linear & generic \\\\\n\t30 & 5c1a27b0-f4c2-11ee-2759-09e46006f0c0 & validity & 1.0 & Linear & greedy \\\\\n\t$\\dots$ & $\\dots$ & $\\dots$ & $\\dots$ & $\\dots$ & $\\dots$ \\\\\n\\end{tabular}\n\n:::\n:::\n\n\n::: {.cell execution_count=21}\n\n::: {.cell-output .cell-output-stdout}\n```\n200×5 DataFrame\n Row │ sample                                variable  value    model   genera ⋯\n     │ Base.UUID                             String    Float64  Symbol  Symbol ⋯\n─────┼──────────────────────────────────────────────────────────────────────────\n   1 │ 5c195b3c-f4c2-11ee-322a-9173776f3b7a  validity      1.0  Linear  gravit ⋯\n   2 │ 5c195b3c-f4c2-11ee-322a-9173776f3b7a  validity      1.0  Linear  growin\n   3 │ 5c195b3c-f4c2-11ee-322a-9173776f3b7a  validity      1.0  Linear  revise\n   4 │ 5c195b3c-f4c2-11ee-322a-9173776f3b7a  validity      1.0  Linear  clue\n   5 │ 5c195b3c-f4c2-11ee-322a-9173776f3b7a  validity      1.0  Linear  probe  ⋯\n   6 │ 5c195b3c-f4c2-11ee-322a-9173776f3b7a  validity      1.0  Linear  dice\n   7 │ 5c195b3c-f4c2-11ee-322a-9173776f3b7a  validity      1.0  Linear  clapro\n   8 │ 5c195b3c-f4c2-11ee-322a-9173776f3b7a  validity      1.0  Linear  wachte\n   9 │ 5c195b3c-f4c2-11ee-322a-9173776f3b7a  validity      1.0  Linear  generi ⋯\n  10 │ 5c195b3c-f4c2-11ee-322a-9173776f3b7a  validity      1.0  Linear  greedy\n  11 │ 5c1a277e-f4c2-11ee-0a8e-fb5f14a8e654  validity      1.0  Linear  gravit\n  ⋮  │                  ⋮                       ⋮         ⋮       ⋮            ⋱\n 191 │ 5cc2ba42-f4c2-11ee-3d2a-d5b8e088cf5b  validity      1.0  MLP     gravit\n 192 │ 5cc2ba42-f4c2-11ee-3d2a-d5b8e088cf5b  validity      1.0  MLP     growin ⋯\n 193 │ 5cc2ba42-f4c2-11ee-3d2a-d5b8e088cf5b  validity      1.0  MLP     revise\n 194 │ 5cc2ba42-f4c2-11ee-3d2a-d5b8e088cf5b  validity      1.0  MLP     clue\n 195 │ 5cc2ba42-f4c2-11ee-3d2a-d5b8e088cf5b  validity      1.0  MLP     probe\n 196 │ 5cc2ba42-f4c2-11ee-3d2a-d5b8e088cf5b  validity      1.0  MLP     dice   ⋯\n 197 │ 5cc2ba42-f4c2-11ee-3d2a-d5b8e088cf5b  validity      1.0  MLP     clapro\n 198 │ 5cc2ba42-f4c2-11ee-3d2a-d5b8e088cf5b  validity      1.0  MLP     wachte\n 199 │ 5cc2ba42-f4c2-11ee-3d2a-d5b8e088cf5b  validity      1.0  MLP     generi\n 200 │ 5cc2ba42-f4c2-11ee-3d2a-d5b8e088cf5b  validity      1.0  MLP     greedy ⋯\n                                                   1 column and 179 rows omitted\n```\n:::\n:::\n\n\nOptionally, you can instead provide a dictionary of `models` and `generators` as before. Each value in the `models` dictionary should be one of two things:\n\na.  Either be an object `M` of type [`AbstractFittedModel`](@ref) that implements the [`Models.train`](@ref) method.\nb.  Or a `DataType` that can be called on [`CounterfactualData`](@ref) to create an object `M` as in (a).\n\n## Multiple Datasets\n\nBenchmarks are run on single instances of type [`CounterfactualData`](@ref). This is our design choice for two reasons:\n\n1.  We want to avoid the loops inside the `benchmark` method(s) from getting too nested and convoluted.\n2.  While it is straightforward to infer metadata for models and generators, this is not the case for datasets.\n\nFortunately, it is very easy to run benchmarks for multiple datasets anyway, since `Benchmark` instances can be concatenated. To see how, let's consider an example involving multiple datasets, models and generators:\n\n::: {.cell execution_count=22}\n``` {.julia .cell-code}\n# Data:\ndatasets = Dict(\n    :moons => CounterfactualData(load_moons()...),\n    :circles => CounterfactualData(load_circles()...),\n)\n\n# Models:\nmodels = Dict(\n    :MLP => FluxModel,\n    :Linear => Linear,\n)\n\n# Generators:\ngenerators = Dict(\n    :Generic => GenericGenerator(),\n    :Greedy => GreedyGenerator(),\n)\n```\n:::\n\n\nThen we can simply loop over the datasets and eventually concatenate the results like so:\n\n::: {.cell execution_count=23}\n``` {.julia .cell-code}\nusing CounterfactualExplanations.Evaluation: distance_measures\nbmks = []\nfor (dataname, dataset) in datasets\n    bmk = benchmark(dataset; models=models, generators=generators, measure=distance_measures)\n    push!(bmks, bmk)\nend\nbmk = vcat(bmks[1], bmks[2]; ids=collect(keys(datasets)))\n```\n:::\n\n\nWhen `ids` are supplied, then a new id column is added to the evaluation data frame that contains unique identifiers for the different benchmarks. The optional `idcol_name` argument can be used to specify the name for that indicator column (defaults to `\"dataset\"`):\n\n::: {.cell execution_count=24}\n``` {.julia .cell-code}\n@chain bmk() begin\n    @group_by(dataset, generator)\n    @filter(model == :MLP)\n    @filter(variable == \"distance_l1\")\n    @summarize(L1_norm=mean(value))\n    @ungroup\nend\n```\n\n::: {.cell-output .cell-output-display .cell-output-markdown execution_count=25}\n\\begin{tabular}{r|ccc}\n\t& dataset & generator & L1\\_norm\\\\\n\t\\hline\n\t& Symbol & Symbol & Float32\\\\\n\t\\hline\n\t1 & moons & Generic & 1.56555 \\\\\n\t2 & moons & Greedy & 0.819269 \\\\\n\t3 & circles & Generic & 1.83524 \\\\\n\t4 & circles & Greedy & 0.498953 \\\\\n\\end{tabular}\n\n:::\n:::\n\n\n::: {.cell execution_count=25}\n\n::: {.cell-output .cell-output-stdout}\n```\n4×3 DataFrame\n Row │ dataset  generator  L1_norm  \n     │ Symbol   Symbol     Float32  \n─────┼──────────────────────────────\n   1 │ moons    Generic    1.56555\n   2 │ moons    Greedy     0.819269\n   3 │ circles  Generic    1.83524\n   4 │ circles  Greedy     0.498953\n```\n:::\n:::\n\n\n",
    "supporting": [
      "benchmarking_files"
    ],
    "filters": []
  }
}