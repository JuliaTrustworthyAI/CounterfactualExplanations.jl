{
  "hash": "9c101535e904345f826b087d7e816c6b",
  "result": {
    "engine": "jupyter",
    "markdown": "---\nexecute: \n  output: true\n---\n\n``` @meta\nCurrentModule = CounterfactualExplanations \n```\n\n\n\n``# [Convergence](@id convergence)``{=commonmark}\n\nThe search for counterfactuals can be seen as an optimization problem, where the goal is to find a point in the input space. One questions that has received surprisingly little attention is how to determine when the search has converged. In a recent paper, we have briefly discussed why it is important to consider convergence [@altmeyer2024faithful]:\n\n> One intuitive way to specify convergence is in terms of threshold probabilities: once the predicted probability $p(y^{+}|x^{\\prime})$ exceeds some user-defined threshold γ such that the counterfactual is valid, we could consider the search to have converged. In the binary case, for example, convergence could be defined as $p(y^{+}|x^{\\prime}) > 0.5$ in this sense. Note, however, how this can be expected to yield counterfactuals in the proximity of the decision boundary, a region characterized by high aleatoric uncertainty. In other words, counterfactuals generated in this way would generally not be plausible. To avoid this from happening, we specify convergence in terms of gradients approaching zero for all our experiments and all of our generators. This is allows us to get a cleaner read on how the different counterfactual search objectives affect counterfactual outcomes.\n\nIn the paper, we were primarily interested in benchmarking counterfactuals generated by different search objectives. In other contexts, however, it may be more appropriate to specify convergence in terms of threshold probabilities. Our package allows you to specify convergence in terms of gradients, threshold probabilities or simply in terms of the total number of iterations. In this section, we will show you how to do this.\n\n::: {.cell execution_count=2}\n``` {.julia .cell-code}\nusing CounterfactualExplanations.Convergence\ngenerator = GenericGenerator(λ=0.01)\n```\n\n::: {.cell-output .cell-output-display execution_count=3}\n```\nGradientBasedGenerator(nothing, CounterfactualExplanations.Objectives.distance_l1, 0.01, false, false, Descent(0.1), NamedTuple())\n```\n:::\n:::\n\n\n## Convergence in terms of gradients\n\nAs gradients approach zero, the conditions defined by the search objective and hence the generator are satisfied. We therefore refere to this type of convergece criterium as [`GeneratorConditionsConvergence`](@ref)\n\n::: {.cell execution_count=3}\n``` {.julia .cell-code}\nconv = GeneratorConditionsConvergence(gradient_tol=0.01, max_iter=1000)\nce_gen = generate_counterfactual(x, target, counterfactual_data, M, generator; convergence = conv)\n```\n\n::: {.cell-output .cell-output-display execution_count=4}\n```\nCounterfactualExplanation\nConvergence: ✅ after 179 steps.\n```\n:::\n:::\n\n\n## Convergence in terms of threshold probabilities\n\nIn this case, the search is considered to have converged once the predicted probability $p(y^{+}|x^{\\prime})$ exceeds some user-defined threshold `γ` such that the counterfactual is valid. We refer to this type of convergence criterium as [`DecisionThresholdConvergence`](@ref).\n\n::: {.cell execution_count=4}\n``` {.julia .cell-code}\nconv = DecisionThresholdConvergence(decision_threshold=0.75)\nce_dec = generate_counterfactual(x, target, counterfactual_data, M, generator; convergence = conv)\n```\n\n::: {.cell-output .cell-output-display execution_count=5}\n```\nCounterfactualExplanation\nConvergence: ✅ after 9 steps.\n```\n:::\n:::\n\n\n## Convergence in terms of the total number of iterations\n\nIn this case, the search is considered to have converged once the total number of iterations exceeds some user-defined threshold `max_iter`. We refer to this type of convergence criterium as [`MaxIterConvergence`](@ref).\n\n::: {.cell execution_count=5}\n``` {.julia .cell-code}\nconv = MaxIterConvergence(max_iter=25)\nce_max = generate_counterfactual(x, target, counterfactual_data, M, generator; convergence = conv)\n```\n\n::: {.cell-output .cell-output-display execution_count=6}\n```\nCounterfactualExplanation\nConvergence: ✅ after 25 steps.\n```\n:::\n:::\n\n\n## Comparison\n\n::: {.cell execution_count=6}\n``` {.julia .cell-code}\nplts = []\nfor (ce, titl) in zip([ce_gen, ce_dec, ce_max], [\"Gradient Convergence\", \"Decision Threshold Convergence\", \"Max Iterations Convergence\"])\n    push!(plts, plot(ce; title=titl, cbar=false))\nend\nplot(plts..., layout=(1,3), size=(1200, 380))\n```\n\n::: {.cell-output .cell-output-display execution_count=7}\n![](convergence_files/figure-commonmark/cell-7-output-1.svg){}\n:::\n:::\n\n\n## References\n\n",
    "supporting": [
      "convergence_files"
    ],
    "filters": []
  }
}