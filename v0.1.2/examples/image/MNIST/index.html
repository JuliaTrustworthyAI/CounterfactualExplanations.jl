<!DOCTYPE html>
<html lang="en"><head><meta charset="UTF-8"/><meta name="viewport" content="width=device-width, initial-scale=1.0"/><title>MNIST ¬∑ CounterfactualExplanations.jl</title><script data-outdated-warner src="../../../assets/warner.js"></script><link rel="canonical" href="https://pat-alt.github.io/CounterfactualExplanations.jl/examples/image/MNIST/"/><link href="https://cdnjs.cloudflare.com/ajax/libs/lato-font/3.0.0/css/lato-font.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/juliamono/0.044/juliamono.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.3/css/fontawesome.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.3/css/solid.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.3/css/brands.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/KaTeX/0.13.11/katex.min.css" rel="stylesheet" type="text/css"/><script>documenterBaseURL="../../.."</script><script src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.6/require.min.js" data-main="../../../assets/documenter.js"></script><script src="../../../siteinfo.js"></script><script src="../../../../versions.js"></script><link class="docs-theme-link" rel="stylesheet" type="text/css" href="../../../assets/themes/documenter-dark.css" data-theme-name="documenter-dark" data-theme-primary-dark/><link class="docs-theme-link" rel="stylesheet" type="text/css" href="../../../assets/themes/documenter-light.css" data-theme-name="documenter-light" data-theme-primary/><script src="../../../assets/themeswap.js"></script></head><body><div id="documenter"><nav class="docs-sidebar"><div class="docs-package-name"><span class="docs-autofit"><a href="../../../">CounterfactualExplanations.jl</a></span></div><form class="docs-search" action="../../../search/"><input class="docs-search-query" id="documenter-search-query" name="q" type="text" placeholder="Search docs"/></form><ul class="docs-menu"><li><a class="tocitem" href="../../../">Home</a></li><li><a class="tocitem" href="../../../cats_dogs/">Motivating example</a></li><li><span class="tocitem">Tutorials</span><ul><li><a class="tocitem" href="../../../tutorials/">Overview</a></li><li><a class="tocitem" href="../../../tutorials/binary/">Binary target</a></li><li><a class="tocitem" href="../../../tutorials/models/">Custom models</a></li><li><a class="tocitem" href="../../../tutorials/multi/">Multi-class target</a></li><li><a class="tocitem" href="../../../tutorials/generators/">Custom generators</a></li><li><a class="tocitem" href="../../../tutorials/mutability/">Mutability constraints</a></li><li><a class="tocitem" href="../../../tutorials/interop/">Interoperability</a></li></ul></li><li><span class="tocitem">Counterfactual Generators</span><ul><li><a class="tocitem" href="../../../generators/gradient_based/latent_space_generator/">Latent Space Search</a></li></ul></li><li><span class="tocitem">More examples</span><ul><li><input class="collapse-toggle" id="menuitem-5-1" type="checkbox" checked/><label class="tocitem" for="menuitem-5-1"><span class="docs-label">Image data</span><i class="docs-chevron"></i></label><ul class="collapsed"><li class="is-active"><a class="tocitem" href>MNIST</a><ul class="internal"><li><a class="tocitem" href="#Pre-trained-classifiers"><span>Pre-trained classifiers</span></a></li><li><a class="tocitem" href="#Generating-counterfactuals"><span>Generating counterfactuals</span></a></li></ul></li></ul></li></ul></li><li><span class="tocitem">Contributor&#39;s Guide</span><ul><li><a class="tocitem" href="../../../contributing/">Overview</a></li><li><a class="tocitem" href="../../../contributing/interop/">Interoperability</a></li><li><a class="tocitem" href="../../../contributing/loss/">Loss functions</a></li></ul></li><li><a class="tocitem" href="../../../reference/">Reference</a></li></ul><div class="docs-version-selector field has-addons"><div class="control"><span class="docs-label button is-static is-size-7">Version</span></div><div class="docs-selector control is-expanded"><div class="select is-fullwidth is-size-7"><select id="documenter-version-selector"></select></div></div></div></nav><div class="docs-main"><header class="docs-navbar"><nav class="breadcrumb"><ul class="is-hidden-mobile"><li><a class="is-disabled">More examples</a></li><li><a class="is-disabled">Image data</a></li><li class="is-active"><a href>MNIST</a></li></ul><ul class="is-hidden-tablet"><li class="is-active"><a href>MNIST</a></li></ul></nav><div class="docs-right"><a class="docs-edit-link" href="https://github.com/pat-alt/CounterfactualExplanations.jl/blob/main/docs/src/examples/image/MNIST.md#" title="Edit on GitHub"><span class="docs-icon fab">ÔÇõ</span><span class="docs-label is-hidden-touch">Edit on GitHub</span></a><a class="docs-settings-button fas fa-cog" id="documenter-settings-button" href="#" title="Settings"></a><a class="docs-sidebar-button fa fa-bars is-hidden-desktop" id="documenter-sidebar-button" href="#"></a></div></header><article class="content" id="documenter-page"><h1 id="MNIST"><a class="docs-heading-anchor" href="#MNIST">MNIST</a><a id="MNIST-1"></a><a class="docs-heading-anchor-permalink" href="#MNIST" title="Permalink"></a></h1><p>In this example we will see how different counterfactual generators can be used to explain deep learning models for image classification. In particular, we will look at MNIST data and visually inspect how the different generators perturb images of handwritten digits in order to change the predicted label to a target label. <a href="#fig-samples">Figure¬†1</a> shows a random sample of handwritten digits.</p><p><img src="../www/mnist_samples.png" alt="Figure 1: A few random handwritten digits."/></p><h2 id="Pre-trained-classifiers"><a class="docs-heading-anchor" href="#Pre-trained-classifiers">Pre-trained classifiers</a><a id="Pre-trained-classifiers-1"></a><a class="docs-heading-anchor-permalink" href="#Pre-trained-classifiers" title="Permalink"></a></h2><p>Next we will load two pre-trained deep-learning classifiers:</p><ol><li>Simple MLP - <code>model</code></li><li>Deep ensemble - <code>ensemble</code></li></ol><pre><code class="language-julia hljs">using Flux
using CounterfactualExplanations.Data: mnist_data, mnist_model, mnist_ensemble
X, ys = mnist_data()
model = mnist_model()
ensemble = mnist_ensemble()</code></pre><p>The following code just prepares the models to be used with <code>CounterfactualExplanations.jl</code>:</p><pre><code class="language-julia hljs">using CounterfactualExplanations, CounterfactualExplanations.Models
import CounterfactualExplanations.Models: logits, probs # import functions in order to extend

# MLP:
# Step 1)
struct NeuralNetwork &lt;: Models.AbstractFittedModel
    model::Any
end
# Step 2)
logits(M::NeuralNetwork, X::AbstractArray) = M.model(X)
probs(M::NeuralNetwork, X::AbstractArray)= softmax(logits(M, X))
M = NeuralNetwork(model)

# Deep ensemble:
# Step 1)
struct FittedEnsemble &lt;: Models.AbstractFittedModel
    ensemble::AbstractArray
end
# Step 2)
using Statistics
logits(M::FittedEnsemble, X::AbstractArray) = mean(Flux.stack([nn(X) for nn in M.ensemble],3), dims=3)
probs(M::FittedEnsemble, X::AbstractArray) = mean(Flux.stack([softmax(nn(X)) for nn in M.ensemble],3),dims=3)
M_ensemble=FittedEnsemble(ensemble)</code></pre><h2 id="Generating-counterfactuals"><a class="docs-heading-anchor" href="#Generating-counterfactuals">Generating counterfactuals</a><a id="Generating-counterfactuals-1"></a><a class="docs-heading-anchor-permalink" href="#Generating-counterfactuals" title="Permalink"></a></h2><p>We will look at four different approaches here:</p><ol><li>Generic approach for the MLP (Wachter, Mittelstadt, and Russell 2017).</li><li>Greedy approach for the MLP.</li><li>Generic approach for the deep ensemble.</li><li>Greedy approach for the deep ensemble (Schut et al. 2021).</li></ol><p>They can be implemented using the <code>GenericGenerator</code> and the <code>GreedyGenerator</code>.</p><h3 id="Turning-a-9-into-a-4"><a class="docs-heading-anchor" href="#Turning-a-9-into-a-4">Turning a 9 into a 4</a><a id="Turning-a-9-into-a-4-1"></a><a class="docs-heading-anchor-permalink" href="#Turning-a-9-into-a-4" title="Permalink"></a></h3><p>We will start with an example that should yield intuitive results: the process of turning a handwritten 9 in <a href="#fig-nine">Figure¬†2</a> into a 4 is straight-forward for a human - just erase the top part. Let‚Äôs see how the different algorithmic approaches perform. First, we preprocess the data below, where we impose that the features (pixel values) are constrained to the follwoing domain: ùí≥‚ÄÑ=‚ÄÑ[0,1]‚ÄÑ‚äÇ‚ÄÑ‚Ñù.</p><pre><code class="language-julia hljs">counterfactual_data = CounterfactualData(X,ys&#39;;domain=(0,1))</code></pre><p>Next we choose a random sample for which we will generate counterfactuals in the following:</p><pre><code class="language-julia hljs"># Randomly selected factual:
using Random
Random.seed!(1234)
x = Flux.unsqueeze(select_factual(counterfactual_data, rand(1:size(X)[2])),2)
target = 5
Œ≥ = 0.95</code></pre><p><img src="../www/mnist_original.png" alt="Figure 2: A random handwritten 9."/></p><p>The code below implements the four different approaches one by one. <a href="#fig-example">Figure¬†3</a> shows the resulting counterfactuals. In every case the desired label switch is achieved, that is the corresponding classifier classifies the counterfactual as a four. But arguably from a human perspective only the counterfactuals for the deep ensemble look like a 4. For the MLP, both the generic and the greedy approach generate counterfactuals that look much like adversarial examples.</p><pre><code class="language-julia hljs"># Generic - MLP
generator = GenericGenerator(;loss=:logitcrossentropy)
counterfactual = generate_counterfactual(x, target, counterfactual_data, M, generator; Œ≥=Œ≥)
img = convert2image(reshape(counterfactual.x‚Ä≤,Int(‚àö(input_dim)),Int(‚àö(input_dim))))
plt_wachter = plot(img, title=&quot;MLP - Wachter&quot;)

# Generic - Deep Ensemble
counterfactual = generate_counterfactual(x, target, counterfactual_data, M_ensemble, generator; Œ≥=Œ≥)
img = convert2image(reshape(counterfactual.x‚Ä≤,Int(‚àö(input_dim)),Int(‚àö(input_dim))))
plt_wachter_de = plot(img, title=&quot;Ensemble - Wachter&quot;)

# Greedy - MLP
generator = GreedyGenerator(;loss=:logitcrossentropy)
counterfactual = generate_counterfactual(x, target, counterfactual_data, M, generator; Œ≥=Œ≥)
img = convert2image(reshape(counterfactual.x‚Ä≤,Int(‚àö(input_dim)),Int(‚àö(input_dim))))
plt_greedy = plot(img, title=&quot;MLP - Greedy&quot;)

# Greedy - Deep Ensemble
counterfactual = generate_counterfactual(x, target, counterfactual_data, M_ensemble, generator; Œ≥=Œ≥)
img = convert2image(reshape(counterfactual.x‚Ä≤,Int(‚àö(input_dim)),Int(‚àö(input_dim))))
plt_greedy_de = plot(img, title=&quot;Ensemble - Greedy&quot;)

plt_list = [plt_orig, plt_wachter, plt_greedy, plt_wachter_de, plt_greedy_de]
plt = plot(plt_list...,layout=(1,length(plt_list)),axis=nothing, size=(1200,240))
savefig(plt, joinpath(www_path, &quot;MNIST_9to4.png&quot;))</code></pre><p><img src="../www/MNIST_9to4.png" alt="Figure 3: Counterfactual explanations for MNIST data: turning a 9 into a 4"/></p><h3 id="References"><a class="docs-heading-anchor" href="#References">References</a><a id="References-1"></a><a class="docs-heading-anchor-permalink" href="#References" title="Permalink"></a></h3><p>Schut, Lisa, Oscar Key, Rory Mc Grath, Luca Costabello, Bogdan Sacaleanu, Yarin Gal, et al. 2021. ‚ÄúGenerating Interpretable Counterfactual Explanations by Implicit Minimisation of Epistemic and Aleatoric Uncertainties.‚Äù In <em>International Conference on Artificial Intelligence and Statistics</em>, 1756‚Äì64. PMLR.</p><p>Wachter, Sandra, Brent Mittelstadt, and Chris Russell. 2017. ‚ÄúCounterfactual Explanations Without Opening the Black Box: Automated Decisions and the GDPR.‚Äù <em>Harv. JL &amp; Tech.</em> 31: 841.</p></article><nav class="docs-footer"><a class="docs-footer-prevpage" href="../../../generators/gradient_based/latent_space_generator/">¬´ Latent Space Search</a><a class="docs-footer-nextpage" href="../../../contributing/">Overview ¬ª</a><div class="flexbox-break"></div><p class="footer-message">Powered by <a href="https://github.com/JuliaDocs/Documenter.jl">Documenter.jl</a> and the <a href="https://julialang.org/">Julia Programming Language</a>.</p></nav></div><div class="modal" id="documenter-settings"><div class="modal-background"></div><div class="modal-card"><header class="modal-card-head"><p class="modal-card-title">Settings</p><button class="delete"></button></header><section class="modal-card-body"><p><label class="label">Theme</label><div class="select"><select id="documenter-themepicker"><option value="documenter-light">documenter-light</option><option value="documenter-dark">documenter-dark</option></select></div></p><hr/><p>This document was generated with <a href="https://github.com/JuliaDocs/Documenter.jl">Documenter.jl</a> version 0.27.19 on <span class="colophon-date" title="Wednesday 29 June 2022 15:47">Wednesday 29 June 2022</span>. Using Julia version 1.7.3.</p></section><footer class="modal-card-foot"></footer></div></div></div></body></html>
